{
  "openapi": "3.1.0",
  "info": {
    "title": "Mnemom API",
    "version": "1.0.0",
    "description": "Trust infrastructure for AI agents. Transparent alignment verification, behavioral drift detection, and accountability protocols.",
    "contact": {
      "name": "Mnemom",
      "url": "https://mnemom.ai"
    },
    "license": {
      "name": "Apache 2.0",
      "url": "https://www.apache.org/licenses/LICENSE-2.0"
    }
  },
  "servers": [
    {
      "url": "https://api.mnemom.ai/v1",
      "description": "Production"
    }
  ],
  "tags": [
    {
      "name": "Agents",
      "description": "Agent CRUD, alignment card, claim, and link operations"
    },
    {
      "name": "Traces",
      "description": "Query and retrieve alignment protocol traces"
    },
    {
      "name": "Integrity",
      "description": "AAP integrity score, AIP integrity score, SSM similarity"
    },
    {
      "name": "Checkpoints",
      "description": "AIP integrity checkpoints: list, get, reverify"
    },
    {
      "name": "Drift",
      "description": "AAP drift alerts and AIP drift alerts"
    },
    {
      "name": "Enforcement",
      "description": "Enforcement mode get/set, conscience values CRUD, resolutions"
    },
    {
      "name": "Webhooks",
      "description": "AIP webhook registration and management"
    },
    {
      "name": "Auth",
      "description": "User authentication, profile, account deletion, SSO domain check"
    },
    {
      "name": "Billing",
      "description": "Checkout, portal, subscription, cancel, reactivate, change-plan, invoices, usage, budget alerts, promo validation, API keys, plans, features, enterprise contact"
    },
    {
      "name": "Organizations",
      "description": "Organization CRUD, members, invitations, agents, API keys, SSO configuration"
    },
    {
      "name": "Admin",
      "description": "Admin stats, usage, users, agents, costs, revenue, customers, licenses, coupons, exports, impersonation, suspend/unsuspend"
    },
    {
      "name": "Licensing",
      "description": "License validation (public) and admin license CRUD"
    },
    {
      "name": "Analyze",
      "description": "Single and batch integrity analysis via API key"
    },
    {
      "name": "Blog",
      "description": "Blog posts listing, retrieval, creation, and author profiles"
    },
    {
      "name": "Webhook Notifications",
      "description": "Organization-level webhook endpoints for real-time HTTP POST notifications of integrity, drift, conscience, and billing events"
    },
    {
      "name": "Verification",
      "description": "Public cryptographic verification endpoints for integrity certificates, Merkle proofs, signing keys, and ZK verdict proofs"
    },
    {
      "name": "Agent Containment",
      "description": "Pause, resume, kill, and reactivate agents. Manage auto-containment policies and view containment audit logs."
    },
    {
      "name": "Conscience Values",
      "description": "Per-org custom conscience values for alignment policy injection (Enterprise)"
    },
    {
      "name": "Card Templates",
      "description": "Organization-level alignment card templates that all agents inherit (Enterprise)"
    }
  ],
  "security": [],
  "paths": {
    "/agents/{agent_id}": {
      "get": {
        "operationId": "getAgent",
        "summary": "Get agent by ID",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Agent details. Private agents return a limited response to non-owners.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Agent"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/card": {
      "get": {
        "operationId": "getAgentCard",
        "summary": "Get active alignment card for agent",
        "tags": [
          "Agents"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Active alignment card",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AlignmentCard"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateAgentCard",
        "summary": "Update alignment card",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "ServiceRole": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "card_json": {
                    "$ref": "#/components/schemas/AlignmentCard"
                  },
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Card updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "updated": {
                      "type": "boolean"
                    },
                    "card_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/agents/{agent_id}/claim": {
      "post": {
        "operationId": "claimAgent",
        "summary": "Claim agent with hash proof",
        "tags": [
          "Agents"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "hash_proof"
                ],
                "properties": {
                  "hash_proof": {
                    "type": "string",
                    "description": "SHA-256 hash of agent API key"
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent claimed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "claimed": {
                      "type": "boolean"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "claimed_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "409": {
            "description": "Agent already claimed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/link": {
      "post": {
        "operationId": "linkAgent",
        "summary": "Link claimed agent to authenticated user",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "hash_proof"
                ],
                "properties": {
                  "hash_proof": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent linked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "linked": {
                      "type": "boolean"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "409": {
            "description": "Agent already linked to another account",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/traces": {
      "get": {
        "operationId": "getAgentTraces",
        "summary": "Get traces for agent (AAP query alias)",
        "tags": [
          "Traces"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "traces": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/APTrace"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/traces": {
      "get": {
        "operationId": "queryTraces",
        "summary": "Query traces with filters",
        "tags": [
          "Traces"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Filtered list of traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "traces": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/APTrace"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/traces/{trace_id}": {
      "get": {
        "operationId": "getTrace",
        "summary": "Get single trace by ID",
        "tags": [
          "Traces"
        ],
        "parameters": [
          {
            "name": "trace_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Trace details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/APTrace"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/integrity/{agent_id}": {
      "get": {
        "operationId": "getIntegrityScore",
        "summary": "Compute AAP integrity score",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Integrity score",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/IntegrityScore"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/integrity/aip": {
      "get": {
        "operationId": "getAipIntegrityScore",
        "summary": "AIP integrity score",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "AIP integrity score",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "total_checks": {
                      "type": "integer"
                    },
                    "clear_count": {
                      "type": "integer"
                    },
                    "review_count": {
                      "type": "integer"
                    },
                    "violation_count": {
                      "type": "integer"
                    },
                    "integrity_ratio": {
                      "type": "number"
                    },
                    "latest_verdict": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/ssm/{agent_id}": {
      "get": {
        "operationId": "getSSM",
        "summary": "Get traces with semantic similarity scores",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Traces with similarity scores",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "trace_count": {
                      "type": "integer"
                    },
                    "traces": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/ssm/{agent_id}/timeline": {
      "get": {
        "operationId": "getSSMTimeline",
        "summary": "Get similarity timeline data",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 7,
              "minimum": 1,
              "maximum": 30
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Similarity timeline",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "days": {
                      "type": "integer"
                    },
                    "timeline": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "date": {
                            "type": "string",
                            "format": "date"
                          },
                          "trace_count": {
                            "type": "integer"
                          },
                          "avg_similarity": {
                            "type": "number"
                          },
                          "values_used": {
                            "type": "object",
                            "additionalProperties": {
                              "type": "integer"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/checkpoints": {
      "get": {
        "operationId": "listCheckpoints",
        "summary": "Paginated integrity checkpoints",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          },
          {
            "name": "verdict",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "clear",
                "review_needed",
                "boundary_violation"
              ]
            }
          },
          {
            "name": "session_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated checkpoints",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "checkpoints": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Checkpoint"
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/checkpoints/{checkpoint_id}": {
      "get": {
        "operationId": "getCheckpoint",
        "summary": "Get single checkpoint",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Checkpoint details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Checkpoint"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/reverify": {
      "post": {
        "operationId": "reverifyTraces",
        "summary": "Re-verify AAP traces against updated card",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 40,
              "maximum": 40
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Re-verification results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "card_id": {
                      "type": "string"
                    },
                    "total_traces_in_batch": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "reverified": {
                      "type": "integer"
                    },
                    "still_violating": {
                      "type": "integer"
                    },
                    "now_clean": {
                      "type": "integer"
                    },
                    "errors": {
                      "type": [
                        "array",
                        "null"
                      ],
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/reverify/aip": {
      "post": {
        "operationId": "reverifyAipCheckpoints",
        "summary": "Re-evaluate AIP checkpoints against updated card",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 20
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Re-evaluation results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "card_id": {
                      "type": "string"
                    },
                    "total_in_batch": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "re_evaluated": {
                      "type": "integer"
                    },
                    "resolved_to_clear": {
                      "type": "integer"
                    },
                    "kept_non_clear": {
                      "type": "integer"
                    },
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "errors": {
                      "type": [
                        "array",
                        "null"
                      ],
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/drift/{agent_id}": {
      "get": {
        "operationId": "getAapDrift",
        "summary": "Get AAP drift alerts for agent",
        "tags": [
          "Drift"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Drift detection results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "analyzed_traces": {
                      "type": "integer"
                    },
                    "drift": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/drift/aip": {
      "get": {
        "operationId": "getAipDrift",
        "summary": "Get AIP drift alerts",
        "tags": [
          "Drift"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "AIP drift alerts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "alerts": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/DriftAlert"
                      }
                    },
                    "agent_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/timeline": {
      "get": {
        "operationId": "getTimeline",
        "summary": "Unified dual-rail AIP + AAP timeline",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "maximum": 200
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Timeline events",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "summary": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/enforcement": {
      "get": {
        "operationId": "getEnforcement",
        "summary": "Get AIP enforcement mode",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Enforcement mode",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnforcementMode"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "setEnforcement",
        "summary": "Update AIP enforcement mode",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "mode"
                ],
                "properties": {
                  "mode": {
                    "type": "string",
                    "enum": [
                      "observe",
                      "enforce",
                      "nudge"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Enforcement mode updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "enforcement_mode": {
                      "type": "string"
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/conscience-values": {
      "get": {
        "operationId": "getConscienceValues",
        "summary": "Get conscience values for agent",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Conscience values",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "conscience_values": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ConscienceValue"
                      }
                    },
                    "is_default": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "updateConscienceValues",
        "summary": "Update conscience values",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "conscience_values"
                ],
                "properties": {
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Values updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "conscience_values": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ConscienceValue"
                      }
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "resetConscienceValues",
        "summary": "Reset conscience values to defaults",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Values reset to defaults",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "reset_to_defaults": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/resolve": {
      "post": {
        "operationId": "resolveViolation",
        "summary": "Resolve a concern or violation",
        "tags": [
          "Enforcement"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "target_type",
                  "target_id",
                  "resolution_type"
                ],
                "properties": {
                  "target_type": {
                    "type": "string",
                    "enum": [
                      "checkpoint",
                      "trace"
                    ]
                  },
                  "target_id": {
                    "type": "string"
                  },
                  "resolution_type": {
                    "type": "string",
                    "enum": [
                      "acknowledged",
                      "allow_action",
                      "add_value"
                    ]
                  },
                  "action_name": {
                    "type": "string",
                    "description": "Required when resolution_type is allow_action"
                  },
                  "value_name": {
                    "type": "string",
                    "description": "Required when resolution_type is add_value"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resolution created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "resolution_id": {
                      "type": "string"
                    },
                    "resolution_type": {
                      "type": "string"
                    },
                    "resolved_by": {
                      "type": "string"
                    },
                    "card_modified": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "409": {
            "description": "Resolution already exists",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/resolutions": {
      "get": {
        "operationId": "listResolutions",
        "summary": "List resolutions for an agent",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "List of resolutions",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "resolutions": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/aip/webhooks": {
      "post": {
        "operationId": "registerAipWebhook",
        "summary": "Register AIP webhook",
        "tags": [
          "Webhooks"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "agent_id",
                  "callback_url",
                  "secret",
                  "events"
                ],
                "properties": {
                  "agent_id": {
                    "type": "string"
                  },
                  "callback_url": {
                    "type": "string",
                    "format": "uri"
                  },
                  "secret": {
                    "type": "string"
                  },
                  "events": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Webhook registered",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "registration_id": {
                      "type": "string"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "callback_url": {
                      "type": "string"
                    },
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/aip/webhooks/{registration_id}": {
      "delete": {
        "operationId": "deleteAipWebhook",
        "summary": "Remove AIP webhook",
        "tags": [
          "Webhooks"
        ],
        "parameters": [
          {
            "name": "registration_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Webhook deleted"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/auth/me": {
      "get": {
        "operationId": "getMe",
        "summary": "Get authenticated user info and linked agents",
        "tags": [
          "Auth"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User profile",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "user_id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "agents": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Agent"
                      }
                    },
                    "billing_account_id": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "plan_id": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "org": {
                      "type": [
                        "object",
                        "null"
                      ],
                      "properties": {
                        "org_id": {
                          "type": "string"
                        },
                        "org_name": {
                          "type": "string"
                        },
                        "role": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/auth/delete-account": {
      "delete": {
        "operationId": "deleteAccount",
        "summary": "Delete authenticated user account and unlink agents",
        "tags": [
          "Auth"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Account deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/auth/sso/check-domain": {
      "get": {
        "operationId": "checkSsoDomain",
        "summary": "Check if email domain has SSO enabled",
        "tags": [
          "Auth"
        ],
        "parameters": [
          {
            "name": "email",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "email"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "SSO domain check result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "sso_enabled": {
                      "type": "boolean"
                    },
                    "org_id": {
                      "type": "string"
                    },
                    "org_name": {
                      "type": "string"
                    },
                    "provider_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/billing/checkout": {
      "post": {
        "operationId": "createCheckout",
        "summary": "Create Stripe checkout session",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "plan_id"
                ],
                "properties": {
                  "plan_id": {
                    "type": "string"
                  },
                  "annual": {
                    "type": "boolean",
                    "default": false
                  },
                  "promo_code": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Checkout session URL",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "url": {
                      "type": "string"
                    },
                    "session_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/portal": {
      "post": {
        "operationId": "createPortalSession",
        "summary": "Create Stripe billing portal session",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Portal session URL",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/subscription": {
      "get": {
        "operationId": "getSubscription",
        "summary": "Get current subscription details",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Subscription details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Subscription"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/cancel": {
      "post": {
        "operationId": "cancelSubscription",
        "summary": "Cancel subscription at period end",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Cancellation confirmed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "canceled": {
                      "type": "boolean"
                    },
                    "cancel_at_period_end": {
                      "type": "boolean"
                    },
                    "current_period_end": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/reactivate": {
      "post": {
        "operationId": "reactivateSubscription",
        "summary": "Reactivate a subscription scheduled for cancellation",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Reactivation confirmed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reactivated": {
                      "type": "boolean"
                    },
                    "cancel_at_period_end": {
                      "type": "boolean"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/change-plan": {
      "post": {
        "operationId": "changePlan",
        "summary": "Change subscription plan",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "plan_id"
                ],
                "properties": {
                  "plan_id": {
                    "type": "string"
                  },
                  "annual": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Plan changed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "updated": {
                      "type": "boolean"
                    },
                    "plan_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/invoices": {
      "get": {
        "operationId": "listInvoices",
        "summary": "List invoices",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Invoice list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "invoices": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Invoice"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/me": {
      "get": {
        "operationId": "getMyBilling",
        "summary": "Get authenticated user billing summary",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Billing summary",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/features": {
      "get": {
        "operationId": "getFeatures",
        "summary": "Get plan feature flags for authenticated user",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Plan features",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plan_id": {
                      "type": "string"
                    },
                    "feature_flags": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "boolean"
                      }
                    },
                    "limits": {
                      "type": "object"
                    },
                    "included_checks": {
                      "type": "integer"
                    },
                    "check_count_this_period": {
                      "type": "integer"
                    },
                    "subscription_status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/usage": {
      "get": {
        "operationId": "getMyUsage",
        "summary": "Get usage metrics for current user",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 30,
              "minimum": 1,
              "maximum": 90
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Usage data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UsageMetrics"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/usage/agents": {
      "get": {
        "operationId": "getMyAgentUsage",
        "summary": "Get per-agent usage breakdown",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 30,
              "minimum": 1,
              "maximum": 90
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Per-agent usage data",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/budget-alert": {
      "get": {
        "operationId": "getBudgetAlert",
        "summary": "Get budget alert settings",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Budget alert settings",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "threshold_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "last_alert_sent_at": {
                      "type": [
                        "string",
                        "null"
                      ],
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      },
      "put": {
        "operationId": "setBudgetAlert",
        "summary": "Set budget alert threshold",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "threshold_cents": {
                    "type": [
                      "integer",
                      "null"
                    ],
                    "minimum": 0
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Budget alert updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "threshold_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/export/usage": {
      "get": {
        "operationId": "exportUsage",
        "summary": "Export usage data as CSV",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "from",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Start date (YYYY-MM-DD)"
          },
          {
            "name": "to",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "End date (YYYY-MM-DD)"
          }
        ],
        "responses": {
          "200": {
            "description": "CSV file",
            "content": {
              "text/csv": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/validate-promo": {
      "post": {
        "operationId": "validatePromo",
        "summary": "Validate a promo code",
        "tags": [
          "Billing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "code"
                ],
                "properties": {
                  "code": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Promo validation result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "discount_percent": {
                      "type": [
                        "number",
                        "null"
                      ]
                    },
                    "discount_amount_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "name": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/enterprise/contact": {
      "post": {
        "operationId": "enterpriseContact",
        "summary": "Submit enterprise contact form",
        "tags": [
          "Billing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "email",
                  "company"
                ],
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "company": {
                    "type": "string"
                  },
                  "role": {
                    "type": "string"
                  },
                  "company_size": {
                    "type": "string"
                  },
                  "message": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Inquiry submitted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/plans": {
      "get": {
        "operationId": "listPublicPlans",
        "summary": "List public pricing plans",
        "tags": [
          "Billing"
        ],
        "responses": {
          "200": {
            "description": "Public plans",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plans": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Plan"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/api-keys": {
      "post": {
        "operationId": "createApiKey",
        "summary": "Create a personal API key",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "maxLength": 100,
                    "default": "Default"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "API key created (secret shown once)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiKey"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      },
      "get": {
        "operationId": "listApiKeys",
        "summary": "List active API keys",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "API key list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ApiKey"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/api-keys/{key_id}": {
      "delete": {
        "operationId": "revokeApiKey",
        "summary": "Revoke an API key",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "key_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Key revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "key_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs": {
      "post": {
        "operationId": "createOrg",
        "summary": "Create organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "slug"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 2,
                    "maxLength": 100
                  },
                  "slug": {
                    "type": "string",
                    "minLength": 3,
                    "maxLength": 48,
                    "pattern": "^[a-z0-9][a-z0-9-]*[a-z0-9]$"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Organization created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "409": {
            "description": "Slug taken or user already in org",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "get": {
        "operationId": "listMyOrgs",
        "summary": "List organizations for authenticated user",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Organizations list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "orgs": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Organization"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/orgs/{org_id}": {
      "get": {
        "operationId": "getOrg",
        "summary": "Get organization details",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateOrg",
        "summary": "Update organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "slug": {
                    "type": "string"
                  },
                  "billing_email": {
                    "type": "string"
                  },
                  "company_name": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Organization updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "deleteOrg",
        "summary": "Delete organization (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/members": {
      "get": {
        "operationId": "listMembers",
        "summary": "List organization members",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Members list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "members": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/OrgMember"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/members/{user_id}": {
      "patch": {
        "operationId": "updateMemberRole",
        "summary": "Update member role (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "role"
                ],
                "properties": {
                  "role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Role updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    },
                    "old_role": {
                      "type": "string"
                    },
                    "new_role": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "removeMember",
        "summary": "Remove member or self-leave",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Member removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "removed": {
                      "type": "boolean"
                    },
                    "org_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/invitations": {
      "post": {
        "operationId": "inviteMember",
        "summary": "Invite member to organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ],
                    "default": "member"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Invitation created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgInvitation"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "get": {
        "operationId": "listInvitations",
        "summary": "List pending invitations",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Invitations list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "invitations": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/OrgInvitation"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/invitations/{invitation_id}": {
      "delete": {
        "operationId": "revokeInvitation",
        "summary": "Revoke a pending invitation",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "invitation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Invitation revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "invitation_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/invitations/accept": {
      "post": {
        "operationId": "acceptInvitation",
        "summary": "Accept an organization invitation",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "token"
                ],
                "properties": {
                  "token": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Invitation accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {
                      "type": "string"
                    },
                    "org_name": {
                      "type": "string"
                    },
                    "role": {
                      "type": "string"
                    },
                    "personal_subscription_warning": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/orgs/{org_id}/agents": {
      "get": {
        "operationId": "getOrgAgents",
        "summary": "List agents in organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "mine",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "Filter to only current user's agents"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization agents",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agents": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Agent"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/pause": {
      "post": {
        "operationId": "pauseAgent",
        "summary": "Pause an agent",
        "description": "Temporarily stop an agent from making API requests. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Reason for pausing the agent"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent paused successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["paused"]},
                    "contained_at": {"type": "string", "format": "date-time"},
                    "contained_by": {"type": "string"},
                    "containment_reason": {"type": "string", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is already paused"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/resume": {
      "post": {
        "operationId": "resumeAgent",
        "summary": "Resume a paused agent",
        "description": "Resume a paused agent back to active state. Only works on paused agents. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Agent resumed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["active"]}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is not paused"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/kill": {
      "post": {
        "operationId": "killAgent",
        "summary": "Kill an agent",
        "description": "Permanently stop an agent. Requires explicit reactivation to restore. Owner only.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Reason for killing the agent"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent killed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["killed"]},
                    "contained_at": {"type": "string", "format": "date-time"},
                    "contained_by": {"type": "string"},
                    "containment_reason": {"type": "string", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is already killed"},
          "403": {"description": "Insufficient permissions - owner only"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/reactivate": {
      "post": {
        "operationId": "reactivateAgent",
        "summary": "Reactivate a killed agent",
        "description": "Restore a killed agent back to active state. Owner only.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Agent reactivated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["active"]}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is not killed"},
          "403": {"description": "Insufficient permissions - owner only"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/containment": {
      "get": {
        "operationId": "getAgentContainment",
        "summary": "Get agent containment status",
        "description": "Returns the current containment status and recent audit log entries. Any org role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Containment status",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "status": {"type": "string", "enum": ["active", "paused", "killed"]},
                    "contained_at": {"type": "string", "format": "date-time", "nullable": true},
                    "contained_by": {"type": "string", "nullable": true},
                    "containment_reason": {"type": "string", "nullable": true},
                    "auto_containment_threshold": {"type": "integer", "nullable": true},
                    "log": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {"type": "string"},
                          "action": {"type": "string"},
                          "actor": {"type": "string"},
                          "reason": {"type": "string", "nullable": true},
                          "previous_status": {"type": "string"},
                          "new_status": {"type": "string"},
                          "created_at": {"type": "string", "format": "date-time"}
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/containment-policy": {
      "put": {
        "operationId": "updateContainmentPolicy",
        "summary": "Update auto-containment policy",
        "description": "Set or disable the auto-containment threshold. When set, the agent will be automatically paused after N consecutive boundary violations. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["auto_containment_threshold"],
                "properties": {
                  "auto_containment_threshold": {
                    "type": "integer",
                    "minimum": 2,
                    "nullable": true,
                    "description": "Number of consecutive boundary violations before auto-pause. Set to null to disable."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Policy updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "auto_containment_threshold": {"type": "integer", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Invalid threshold value"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/api-keys": {
      "post": {
        "operationId": "createOrgApiKey",
        "summary": "Create organization API key",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "maxLength": 100
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Org API key created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiKey"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "get": {
        "operationId": "listOrgApiKeys",
        "summary": "List organization API keys",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Org API keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ApiKey"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/api-keys/{key_id}": {
      "delete": {
        "operationId": "revokeOrgApiKey",
        "summary": "Revoke organization API key",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "key_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Key revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "key_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/sso": {
      "get": {
        "operationId": "getSsoConfig",
        "summary": "Get SSO configuration for organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "SSO config or not configured",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "configureSso",
        "summary": "Configure SAML SSO for organization (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "metadata_url",
                  "allowed_domains"
                ],
                "properties": {
                  "metadata_url": {
                    "type": "string",
                    "format": "uri"
                  },
                  "idp_name": {
                    "type": "string"
                  },
                  "default_role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ],
                    "default": "member"
                  },
                  "allowed_domains": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "minItems": 1
                  },
                  "enforced": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "SSO configured",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "removeSso",
        "summary": "Remove SSO configuration (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "SSO removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "removed": {
                      "type": "boolean"
                    },
                    "note": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/sso/test": {
      "post": {
        "operationId": "testSso",
        "summary": "Test SSO metadata URL validity",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metadata_url": {
                    "type": "string",
                    "format": "uri"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "SSO test result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "error": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "metadata_url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/license/validate": {
      "post": {
        "operationId": "validateLicense",
        "summary": "Validate a license key (public)",
        "tags": [
          "Licensing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "license",
                  "instance_id"
                ],
                "properties": {
                  "license": {
                    "type": "string",
                    "description": "License JWT token"
                  },
                  "instance_id": {
                    "type": "string",
                    "description": "Unique instance identifier"
                  },
                  "instance_metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "License valid",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "license_id": {
                      "type": "string"
                    },
                    "plan_id": {
                      "type": "string"
                    },
                    "feature_flags": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "boolean"
                      }
                    },
                    "limits": {
                      "type": "object"
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "next_check_seconds": {
                      "type": "integer"
                    },
                    "warning": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Invalid license",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "License revoked",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "409": {
            "description": "Max activations exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "activation_count": {
                      "type": "integer"
                    },
                    "max_activations": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "410": {
            "description": "License expired",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/analyze": {
      "post": {
        "operationId": "analyze",
        "summary": "Run single integrity analysis",
        "tags": [
          "Analyze"
        ],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "thinking_block",
                  "thinking_metadata",
                  "agent_id",
                  "session_id",
                  "card"
                ],
                "properties": {
                  "thinking_block": {
                    "type": "string"
                  },
                  "thinking_metadata": {
                    "type": "object",
                    "required": [
                      "provider",
                      "model"
                    ],
                    "properties": {
                      "provider": {
                        "type": "string"
                      },
                      "model": {
                        "type": "string"
                      }
                    }
                  },
                  "agent_id": {
                    "type": "string"
                  },
                  "session_id": {
                    "type": "string"
                  },
                  "card": {
                    "type": "object",
                    "required": [
                      "card_id",
                      "values"
                    ],
                    "properties": {
                      "card_id": {
                        "type": "string"
                      },
                      "values": {
                        "type": "array",
                        "items": {
                          "type": "object"
                        }
                      }
                    }
                  },
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  },
                  "window_context": {
                    "type": "array",
                    "items": {
                      "type": "object"
                    }
                  },
                  "task_context": {
                    "type": "string"
                  },
                  "store_checkpoint": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Analysis result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "checkpoint": {
                      "$ref": "#/components/schemas/Checkpoint"
                    },
                    "proceed": {
                      "type": "boolean"
                    },
                    "recommended_action": {
                      "type": "string"
                    },
                    "window_summary": {
                      "type": "object"
                    },
                    "metering": {
                      "type": "object",
                      "properties": {
                        "event_id": {
                          "type": "string"
                        },
                        "account_id": {
                          "type": "string"
                        },
                        "billed": {
                          "type": "boolean"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "402": {
            "description": "Quota exceeded or account suspended",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/analyze/batch": {
      "post": {
        "operationId": "analyzeBatch",
        "summary": "Run batch integrity analysis (1-50 items)",
        "tags": [
          "Analyze"
        ],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "items"
                ],
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object"
                    },
                    "minItems": 1,
                    "maxItems": 50,
                    "description": "Array of analysis requests (same shape as POST /analyze body)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Batch analysis results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "metering": {
                      "type": "object",
                      "properties": {
                        "total_events": {
                          "type": "integer"
                        },
                        "account_id": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "402": {
            "description": "Quota exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/blog/posts": {
      "get": {
        "operationId": "listBlogPosts",
        "summary": "List published blog posts",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          },
          {
            "name": "agent_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Blog post list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "posts": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      },
      "post": {
        "operationId": "createBlogPost",
        "summary": "Create blog post (service role only)",
        "tags": [
          "Blog"
        ],
        "security": [
          {
            "ServiceRole": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "agent_id",
                  "slug",
                  "title",
                  "body"
                ],
                "properties": {
                  "agent_id": {
                    "type": "string"
                  },
                  "slug": {
                    "type": "string",
                    "pattern": "^[a-z0-9-]+$"
                  },
                  "title": {
                    "type": "string"
                  },
                  "subtitle": {
                    "type": "string"
                  },
                  "body": {
                    "type": "string"
                  },
                  "tags": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "investigation_session_id": {
                    "type": "string"
                  },
                  "trace_ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "draft",
                      "published"
                    ],
                    "default": "draft"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Post created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "409": {
            "description": "Duplicate slug",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/blog/posts/{slug}": {
      "get": {
        "operationId": "getBlogPost",
        "summary": "Get single blog post by slug",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "slug",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Blog post with linked traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "post": {
                      "type": "object"
                    },
                    "linked_traces": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/blog/authors/{agent_id}": {
      "get": {
        "operationId": "getBlogAuthor",
        "summary": "Get author profile and their posts",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Author and posts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "author": {
                      "$ref": "#/components/schemas/Agent"
                    },
                    "posts": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks": {
      "post": {
        "operationId": "createWebhookEndpoint",
        "summary": "Create a webhook endpoint",
        "description": "Create a new webhook endpoint for the organization. Returns the signing secret (shown only once). Maximum 5 endpoints per organization.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["url"],
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "HTTPS URL that will receive webhook POST requests"
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable description of this endpoint"
                  },
                  "event_types": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["integrity.violation", "integrity.checkpoint", "drift.detected", "drift.resolved", "conscience.escalation", "quota.warning", "quota.exceeded", "subscription.status_changed"]
                    },
                    "description": "Event types to subscribe to. Empty array means all events."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Webhook endpoint created. Response includes signing_secret (shown only once).",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpoint"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      },
      "get": {
        "operationId": "listWebhookEndpoints",
        "summary": "List webhook endpoints",
        "description": "List all webhook endpoints for the organization. Signing secrets are not included.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "List of webhook endpoints",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/WebhookEndpointPublic"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}": {
      "get": {
        "operationId": "getWebhookEndpoint",
        "summary": "Get webhook endpoint details",
        "description": "Get details for a single webhook endpoint. Signing secret is not included.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Webhook endpoint details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpointPublic"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateWebhookEndpoint",
        "summary": "Update webhook endpoint",
        "description": "Update an existing webhook endpoint. Re-enabling a disabled endpoint resets the failure counter.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "New HTTPS URL"
                  },
                  "description": {
                    "type": "string"
                  },
                  "event_types": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["integrity.violation", "integrity.checkpoint", "drift.detected", "drift.resolved", "conscience.escalation", "quota.warning", "quota.exceeded", "subscription.status_changed"]
                    }
                  },
                  "is_active": {
                    "type": "boolean",
                    "description": "Set to true to re-enable a disabled endpoint (resets failure counter)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated endpoint",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpointPublic"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "deleteWebhookEndpoint",
        "summary": "Delete webhook endpoint",
        "description": "Permanently delete a webhook endpoint and all its delivery history.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Endpoint deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {
                      "type": "boolean"
                    },
                    "endpoint_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}/rotate-secret": {
      "post": {
        "operationId": "rotateWebhookSecret",
        "summary": "Rotate webhook signing secret",
        "description": "Generate a new signing secret for the endpoint. The new secret is returned once. Previous secret is immediately invalidated.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "New signing secret (shown only once)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "endpoint_id": {
                      "type": "string"
                    },
                    "signing_secret": {
                      "type": "string",
                      "description": "New 32-byte hex-encoded signing secret. Store securely  not retrievable again."
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}/test": {
      "post": {
        "operationId": "testWebhookEndpoint",
        "summary": "Send test webhook delivery",
        "description": "Send a synchronous test delivery to the endpoint with a synthetic webhook.test event. Returns the delivery result immediately.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Test delivery result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "status": {
                      "type": ["integer", "null"],
                      "description": "HTTP response status code from the endpoint"
                    },
                    "latency_ms": {
                      "type": ["integer", "null"],
                      "description": "Round-trip time in milliseconds"
                    },
                    "error": {
                      "type": ["string", "null"],
                      "description": "Error message if delivery failed"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/deliveries": {
      "get": {
        "operationId": "getWebhookDeliveryLog",
        "summary": "Get webhook delivery log",
        "description": "Paginated delivery log for the organization. Optionally filter by endpoint_id.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "endpoint_id",
            "in": "query",
            "schema": {
              "type": "string"
            },
            "description": "Filter deliveries to a specific endpoint"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "maximum": 100
            },
            "description": "Number of deliveries to return (max 100)"
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            },
            "description": "Offset for pagination"
          }
        ],
        "responses": {
          "200": {
            "description": "Delivery log entries",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/WebhookDelivery"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/deliveries/{delivery_id}/redeliver": {
      "post": {
        "operationId": "redeliverWebhookEvent",
        "summary": "Redeliver a webhook event",
        "description": "Create a new delivery attempt for a previously failed event. A new delivery row is created with next_attempt_at set to now.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "delivery_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Delivery identifier (e.g. whd-abc12345)"
          }
        ],
        "responses": {
          "201": {
            "description": "New delivery created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "delivery_id": {
                      "type": "string"
                    },
                    "event_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["pending"]
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/admin/webhooks/health": {
      "get": {
        "operationId": "adminWebhookHealth",
        "summary": "Get platform-wide webhook health metrics",
        "description": "Admin-only endpoint returning active endpoints count, 24h success rate, disabled endpoints, and top event types.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Webhook health metrics",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "active_endpoints": {
                      "type": "integer"
                    },
                    "disabled_endpoints": {
                      "type": "integer"
                    },
                    "deliveries_24h": {
                      "type": "integer"
                    },
                    "success_24h": {
                      "type": "integer"
                    },
                    "failed_24h": {
                      "type": "integer"
                    },
                    "success_rate_24h": {
                      "type": "number"
                    },
                    "top_event_types": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "event_type": {
                            "type": "string"
                          },
                          "count": {
                            "type": "integer"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/v1/keys": {
      "get": {
        "operationId": "getSigningKeys",
        "summary": "List signing keys",
        "description": "List all active Ed25519 signing public keys. Public endpoint, no authentication required. These keys are used to verify IntegrityCertificate signatures.",
        "tags": ["Verification"],
        "security": [{}],
        "responses": {
          "200": {
            "description": "List of active signing keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/SigningKeyInfo"
                      }
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/verify": {
      "post": {
        "operationId": "verifyCertificate",
        "summary": "Verify certificate",
        "description": "Verify an IntegrityCertificate. Performs Ed25519 signature verification, chain hash verification, Merkle inclusion proof verification, input commitment check, and optional STARK proof verification. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["certificate"],
                "properties": {
                  "certificate": {
                    "$ref": "#/components/schemas/IntegrityCertificate"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Verification result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/VerifyCertificateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request body or certificate structure",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/certificate": {
      "get": {
        "operationId": "getCheckpointCertificate",
        "summary": "Get integrity certificate",
        "description": "Retrieve or reconstruct the IntegrityCertificate for a checkpoint. Includes signature, chain proof, Merkle inclusion proof (if available), and verdict derivation proof (if completed). Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "The integrity certificate",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/IntegrityCertificate"
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found or certificate not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/inclusion-proof": {
      "get": {
        "operationId": "getInclusionProof",
        "summary": "Get inclusion proof",
        "description": "Generate and return a Merkle inclusion proof for a checkpoint. The proof contains O(log N) sibling hashes sufficient to recompute the Merkle root, proving the checkpoint is included in the agent's complete checkpoint history. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "Merkle inclusion proof",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InclusionProofResponse"
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found or no Merkle proof available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Merkle leaf index out of bounds",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/prove": {
      "post": {
        "operationId": "requestZkProof",
        "summary": "Request ZK proof",
        "description": "Request a zero-knowledge proof for a checkpoint's verdict derivation. If a proof already exists, returns its current status. Otherwise, creates a pending proof request and dispatches it to the RISC Zero prover service. Requires API key authentication.",
        "tags": ["Verification"],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "202": {
            "description": "Proof request accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "proof_id": {
                      "type": "string",
                      "description": "Proof identifier (prf-{8 random chars})"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["queued"],
                      "description": "Initial status"
                    },
                    "estimated_completion_ms": {
                      "type": "integer",
                      "description": "Estimated time to completion in milliseconds"
                    }
                  }
                }
              }
            }
          },
          "200": {
            "description": "Proof already exists for this checkpoint",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "proof_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to create proof request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/proof": {
      "get": {
        "operationId": "getProofStatus",
        "summary": "Get proof status",
        "description": "Get the ZK proof status and data for a checkpoint. Returns the most recent proof record including status, proof type, verification result, and timing metadata. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "Proof status and data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProofStatusResponse"
                }
              }
            }
          },
          "404": {
            "description": "No proof found for this checkpoint",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/agents/{agent_id}/merkle-root": {
      "get": {
        "operationId": "getAgentMerkleRoot",
        "summary": "Get Merkle root",
        "description": "Get the current Merkle tree root for an agent. The root is a SHA-256 hash that commits to the complete set of integrity checkpoints for this agent. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The agent ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Merkle tree root and metadata",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MerkleRootResponse"
                }
              }
            }
          },
          "404": {
            "description": "No Merkle tree found for this agent",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values": {
      "get": {
        "operationId": "listOrgConscienceValues",
        "summary": "List org conscience values",
        "description": "Returns all conscience values for the org, along with mode and enabled status. Requires Enterprise plan with custom_conscience_values feature flag.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Conscience values list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "mode": {"type": "string", "enum": ["augment", "replace"]},
                    "enabled": {"type": "boolean"},
                    "values": {"type": "array", "items": {"$ref": "#/components/schemas/OrgConscienceValue"}}
                  }
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      },
      "post": {
        "operationId": "createOrgConscienceValue",
        "summary": "Create org conscience value",
        "description": "Create a new custom conscience value. Max 20 per org. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name", "description", "type"],
                "properties": {
                  "name": {"type": "string", "minLength": 1, "maxLength": 50},
                  "description": {"type": "string", "minLength": 1, "maxLength": 500},
                  "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
                  "severity": {"type": "string", "enum": ["advisory", "mandatory"], "default": "advisory"}
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/OrgConscienceValue"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      }
    },
    "/orgs/{org_id}/conscience-values/{value_id}": {
      "patch": {
        "operationId": "updateOrgConscienceValue",
        "summary": "Update org conscience value",
        "description": "Update fields on an existing conscience value. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "value_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {"type": "string", "minLength": 1, "maxLength": 50},
                  "description": {"type": "string", "minLength": 1, "maxLength": 500},
                  "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
                  "severity": {"type": "string", "enum": ["advisory", "mandatory"]},
                  "is_active": {"type": "boolean"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/OrgConscienceValue"}
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "delete": {
        "operationId": "deleteOrgConscienceValue",
        "summary": "Delete org conscience value",
        "description": "Permanently delete a conscience value. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "value_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"},
                    "id": {"type": "string"}
                  }
                }
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/orgs/{org_id}/conscience-values/order": {
      "put": {
        "operationId": "reorderOrgConscienceValues",
        "summary": "Reorder org conscience values",
        "description": "Set the sort order for all conscience values.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["order"],
                "properties": {
                  "order": {"type": "array", "items": {"type": "string"}}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reordered",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reordered": {"type": "boolean"},
                    "order": {"type": "array", "items": {"type": "string"}}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values/mode": {
      "put": {
        "operationId": "updateOrgConscienceMode",
        "summary": "Update org conscience mode",
        "description": "Set the conscience mode (augment/replace) and enabled flag.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "mode": {"type": "string", "enum": ["augment", "replace"]},
                  "enabled": {"type": "boolean"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "mode": {"type": "string", "enum": ["augment", "replace"]},
                    "enabled": {"type": "boolean"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values/log": {
      "get": {
        "operationId": "getOrgConscienceAuditLog",
        "summary": "Get conscience values audit log",
        "description": "Returns the audit trail for conscience value changes. Requires owner, admin, or auditor role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Audit log entries",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "entries": {"type": "array", "items": {"$ref": "#/components/schemas/OrgConscienceAuditEntry"}}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/users/{userId}/impersonate": {
      "post": {
        "operationId": "startImpersonation",
        "summary": "Start impersonation session",
        "description": "Creates a session-based impersonation for viewing the dashboard as the target user. Returns an opaque token to include as X-Impersonate-Token header. Sessions expire after 1 hour.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Target user ID to impersonate"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Optional reason for impersonation (audit trail)"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Impersonation session created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_id": {"type": "string"},
                    "token": {"type": "string", "description": "Opaque token for X-Impersonate-Token header"},
                    "target_user_id": {"type": "string"},
                    "target_email": {"type": "string"},
                    "expires_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "403": {"description": "Cannot impersonate admin users"},
          "404": {"description": "Target user not found"}
        }
      }
    },
    "/admin/impersonation/{sessionId}": {
      "get": {
        "operationId": "getImpersonationSession",
        "summary": "Get impersonation session status",
        "description": "Returns session details if active. Returns 410 Gone if expired or ended.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Impersonation session ID (ais-xxx)"
          }
        ],
        "responses": {
          "200": {
            "description": "Active session details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {"type": "string"},
                    "admin_user_id": {"type": "string"},
                    "target_user_id": {"type": "string"},
                    "target_email": {"type": "string"},
                    "reason": {"type": "string", "nullable": true},
                    "started_at": {"type": "string", "format": "date-time"},
                    "expires_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "404": {"description": "Session not found"},
          "410": {"description": "Session expired or ended"}
        }
      }
    },
    "/admin/impersonation/{sessionId}/end": {
      "post": {
        "operationId": "endImpersonation",
        "summary": "End impersonation session",
        "description": "Marks the impersonation session as ended. Audit-logged.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Impersonation session ID (ais-xxx)"
          }
        ],
        "responses": {
          "200": {
            "description": "Session ended",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ended": {"type": "boolean"},
                    "session_id": {"type": "string"}
                  }
                }
              }
            }
          },
          "403": {"description": "Not your impersonation session"},
          "404": {"description": "Session not found"}
        }
      }
    },
    "/orgs/{org_id}/card-template": {
      "get": {
        "operationId": "getOrgCardTemplate",
        "summary": "Get org card template",
        "description": "Returns the organization's alignment card template, including enabled status and the template card JSON. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Org card template",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgCardTemplate"
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "put": {
        "operationId": "updateOrgCardTemplate",
        "summary": "Update org card template",
        "description": "Create or update the organization's alignment card template. All agents in the org will inherit this template. Requires owner or admin role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["enabled", "template"],
                "properties": {
                  "enabled": {"type": "boolean", "description": "Whether the org card template is active"},
                  "template": {"$ref": "#/components/schemas/AlignmentCard", "description": "The alignment card template JSON"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Template updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgCardTemplate"
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      },
      "delete": {
        "operationId": "deleteOrgCardTemplate",
        "summary": "Delete org card template",
        "description": "Delete the organization's alignment card template. All agents revert to using only their individual cards. Requires owner role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Template deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"}
                  }
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/org-card-exempt": {
      "put": {
        "operationId": "setAgentOrgCardExempt",
        "summary": "Set agent org card exemption",
        "description": "Set or remove an agent's exemption from the organization's card template. Exempt agents use only their individual card. Requires owner or admin role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["exempt"],
                "properties": {
                  "exempt": {"type": "boolean", "description": "Whether the agent is exempt from the org card template"},
                  "reason": {"type": "string", "description": "Required when setting exempt=true. Stored in audit trail.", "maxLength": 500}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Exemption updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "exempt": {"type": "boolean"},
                    "reason": {"type": ["string", "null"]},
                    "updated_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase JWT token in Authorization: Bearer header"
      },
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-Mnemom-Api-Key",
        "description": "Mnemom API key (mnm_... format)"
      },
      "ServiceRole": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase service role key for admin and service endpoints"
      }
    },
    "parameters": {
      "AgentId": {
        "name": "agent_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Agent identifier (e.g. smolt-abc123)"
      },
      "OrgId": {
        "name": "org_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Organization identifier (e.g. org-abc12345)"
      },
      "EndpointId": {
        "name": "endpoint_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Webhook endpoint identifier (e.g. whe-abc12345)"
      }
    },
    "responses": {
      "BadRequest": {
        "description": "Bad request",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "Unauthorized": {
        "description": "Authentication required",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "Forbidden": {
        "description": "Forbidden",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "NotFound": {
        "description": "Resource not found",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "required": [
          "error"
        ],
        "properties": {
          "error": {
            "type": "string"
          }
        }
      },
      "Agent": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "agent_hash": {
            "type": "string"
          },
          "user_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "email": {
            "type": [
              "string",
              "null"
            ]
          },
          "claimed_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "last_seen": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "offline"
            ]
          },
          "public": {
            "type": "boolean"
          },
          "aip_enforcement_mode": {
            "type": [
              "string",
              "null"
            ],
            "enum": [
              "observe",
              "enforce",
              "nudge"
            ]
          },
          "billing_account_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "AlignmentCard": {
        "type": "object",
        "properties": {
          "card_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "is_active": {
            "type": "boolean"
          },
          "card_json": {
            "type": "object",
            "description": "Full alignment card JSON per AAP spec"
          },
          "conscience_values": {
            "type": [
              "array",
              "null"
            ],
            "items": {
              "$ref": "#/components/schemas/ConscienceValue"
            }
          },
          "issued_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "APTrace": {
        "type": "object",
        "properties": {
          "trace_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "action": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "category": {
                "type": "string"
              }
            }
          },
          "decision": {
            "type": "object",
            "properties": {
              "selected": {
                "type": "string"
              },
              "selection_reasoning": {
                "type": "string"
              },
              "values_applied": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "confidence": {
                "type": [
                  "number",
                  "null"
                ]
              }
            }
          },
          "verification": {
            "type": [
              "object",
              "null"
            ],
            "properties": {
              "verified": {
                "type": "boolean"
              },
              "violations": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "IntegrityScore": {
        "type": "object",
        "properties": {
          "agent_id": {
            "type": "string"
          },
          "total_traces": {
            "type": "integer"
          },
          "verified_traces": {
            "type": "integer"
          },
          "violation_count": {
            "type": "integer"
          },
          "integrity_score": {
            "type": "number",
            "description": "Value between 0 and 1"
          }
        }
      },
      "Checkpoint": {
        "type": "object",
        "properties": {
          "checkpoint_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "card_id": {
            "type": "string"
          },
          "session_id": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "thinking_block_hash": {
            "type": "string"
          },
          "provider": {
            "type": "string"
          },
          "model": {
            "type": "string"
          },
          "verdict": {
            "type": "string",
            "enum": [
              "clear",
              "review_needed",
              "boundary_violation"
            ]
          },
          "concerns": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "category": {
                  "type": "string"
                },
                "severity": {
                  "type": "string"
                },
                "description": {
                  "type": "string"
                },
                "evidence": {
                  "type": "string"
                }
              }
            }
          },
          "reasoning_summary": {
            "type": "string"
          },
          "conscience_context": {
            "type": "object"
          },
          "window_position": {
            "type": "object",
            "properties": {
              "index": {
                "type": "integer"
              },
              "window_size": {
                "type": "integer"
              }
            }
          },
          "analysis_metadata": {
            "type": "object"
          },
          "linked_trace_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "re_evaluated_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "original_verdict": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "DriftAlert": {
        "type": "object",
        "properties": {
          "alert_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "session_id": {
            "type": "string"
          },
          "checkpoint_ids": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "sustained_checks": {
            "type": "integer"
          },
          "severity": {
            "type": "string",
            "enum": [
              "low",
              "medium",
              "high"
            ]
          },
          "drift_direction": {
            "type": "string"
          },
          "message": {
            "type": "string"
          },
          "detection_timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ConscienceValue": {
        "type": "object",
        "required": [
          "type",
          "name",
          "content"
        ],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "BOUNDARY",
              "FEAR",
              "COMMITMENT",
              "BELIEF",
              "HOPE"
            ]
          },
          "name": {
            "type": "string"
          },
          "content": {
            "type": "string"
          }
        }
      },
      "EnforcementMode": {
        "type": "object",
        "properties": {
          "agent_id": {
            "type": "string"
          },
          "enforcement_mode": {
            "type": "string",
            "enum": [
              "observe",
              "enforce",
              "nudge"
            ],
            "default": "observe"
          }
        }
      },
      "Subscription": {
        "type": "object",
        "properties": {
          "subscription": {
            "type": [
              "object",
              "null"
            ]
          },
          "plan_id": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "check_count_this_period": {
            "type": "integer"
          }
        }
      },
      "Invoice": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "amount_due": {
            "type": "integer"
          },
          "amount_paid": {
            "type": "integer"
          },
          "currency": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "created": {
            "type": "integer"
          },
          "hosted_invoice_url": {
            "type": [
              "string",
              "null"
            ]
          },
          "invoice_pdf": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "UsageMetrics": {
        "type": "object",
        "properties": {
          "daily": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "rollup_date": {
                  "type": "string",
                  "format": "date"
                },
                "check_count": {
                  "type": "integer"
                },
                "tokens_in": {
                  "type": "integer"
                },
                "tokens_out": {
                  "type": "integer"
                }
              }
            }
          },
          "summary": {
            "type": "object",
            "properties": {
              "checks_used": {
                "type": "integer"
              },
              "checks_included": {
                "type": "integer"
              },
              "overage": {
                "type": "integer"
              },
              "estimated_overage_cost": {
                "type": "number"
              },
              "period_start": {
                "type": "string",
                "format": "date-time"
              },
              "period_end": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      },
      "Plan": {
        "type": "object",
        "properties": {
          "plan_id": {
            "type": "string"
          },
          "display_name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "billing_model": {
            "type": "string",
            "enum": [
              "none",
              "metered",
              "subscription",
              "subscription_plus_metered"
            ]
          },
          "base_price_cents": {
            "type": "integer"
          },
          "annual_price_cents": {
            "type": "integer"
          },
          "per_check_price": {
            "type": "number"
          },
          "included_checks": {
            "type": "integer"
          },
          "trace_retention_days": {
            "type": "integer"
          },
          "feature_flags": {
            "type": "object",
            "additionalProperties": {
              "type": "boolean"
            }
          },
          "limits": {
            "type": "object"
          },
          "sort_order": {
            "type": "integer"
          }
        }
      },
      "Organization": {
        "type": "object",
        "properties": {
          "org_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "slug": {
            "type": "string"
          },
          "billing_account_id": {
            "type": "string"
          },
          "owner_user_id": {
            "type": "string"
          },
          "billing_email": {
            "type": [
              "string",
              "null"
            ]
          },
          "company_name": {
            "type": [
              "string",
              "null"
            ]
          },
          "member_count": {
            "type": "integer"
          },
          "role": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "OrgMember": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "role": {
            "type": "string",
            "enum": [
              "owner",
              "admin",
              "member",
              "viewer",
              "auditor"
            ]
          },
          "accepted_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "OrgInvitation": {
        "type": "object",
        "properties": {
          "invitation_id": {
            "type": "string"
          },
          "org_id": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "role": {
            "type": "string"
          },
          "token": {
            "type": "string",
            "description": "Only returned on creation"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "accepted",
              "revoked",
              "expired"
            ]
          },
          "invited_by": {
            "type": "string"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "License": {
        "type": "object",
        "properties": {
          "license_id": {
            "type": "string"
          },
          "account_id": {
            "type": "string"
          },
          "plan_id": {
            "type": "string"
          },
          "feature_flags": {
            "type": "object",
            "additionalProperties": {
              "type": "boolean"
            }
          },
          "limits": {
            "type": "object"
          },
          "max_activations": {
            "type": "integer"
          },
          "is_offline": {
            "type": "boolean"
          },
          "issued_at": {
            "type": "string",
            "format": "date-time"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "revoked_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "revoked_reason": {
            "type": [
              "string",
              "null"
            ]
          },
          "notes": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ApiKey": {
        "type": "object",
        "properties": {
          "key_id": {
            "type": "string"
          },
          "key": {
            "type": "string",
            "description": "Full secret key, only returned on creation"
          },
          "key_prefix": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "org_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "scopes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "last_used_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          }
        }
      },
      "WebhookEndpoint": {
        "type": "object",
        "description": "Webhook endpoint with signing secret (only returned on creation and secret rotation)",
        "properties": {
          "endpoint_id": {
            "type": "string",
            "description": "Unique identifier (whe-xxxxxxxx)"
          },
          "billing_account_id": {
            "type": "string"
          },
          "url": {
            "type": "string",
            "format": "uri"
          },
          "description": {
            "type": "string"
          },
          "signing_secret": {
            "type": "string",
            "description": "32-byte hex-encoded HMAC signing secret. Only returned on creation and rotation."
          },
          "event_types": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Subscribed event types. Empty array means all events."
          },
          "is_active": {
            "type": "boolean"
          },
          "consecutive_failures": {
            "type": "integer"
          },
          "disabled_at": {
            "type": ["string", "null"],
            "format": "date-time"
          },
          "disabled_reason": {
            "type": ["string", "null"]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "WebhookEndpointPublic": {
        "type": "object",
        "description": "Webhook endpoint without signing secret (used in list and get responses)",
        "properties": {
          "endpoint_id": {
            "type": "string"
          },
          "billing_account_id": {
            "type": "string"
          },
          "url": {
            "type": "string",
            "format": "uri"
          },
          "description": {
            "type": "string"
          },
          "event_types": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "is_active": {
            "type": "boolean"
          },
          "consecutive_failures": {
            "type": "integer"
          },
          "disabled_at": {
            "type": ["string", "null"],
            "format": "date-time"
          },
          "disabled_reason": {
            "type": ["string", "null"]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "WebhookDelivery": {
        "type": "object",
        "description": "Webhook delivery log entry",
        "properties": {
          "delivery_id": {
            "type": "string",
            "description": "Unique identifier (whd-xxxxxxxx)"
          },
          "event_id": {
            "type": "string"
          },
          "endpoint_id": {
            "type": "string"
          },
          "event_type": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "delivering", "delivered", "failed", "retrying"]
          },
          "attempt_count": {
            "type": "integer"
          },
          "max_attempts": {
            "type": "integer"
          },
          "last_response_status": {
            "type": ["integer", "null"],
            "description": "HTTP status code from last delivery attempt"
          },
          "last_error": {
            "type": ["string", "null"]
          },
          "latency_ms": {
            "type": ["integer", "null"],
            "description": "Round-trip latency in milliseconds"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "SigningKeyInfo": {
        "type": "object",
        "description": "Ed25519 signing key metadata. Public keys are used to verify IntegrityCertificate signatures.",
        "properties": {
          "key_id": {
            "type": "string",
            "description": "Unique key identifier"
          },
          "public_key": {
            "type": "string",
            "description": "Hex-encoded Ed25519 public key"
          },
          "algorithm": {
            "type": "string",
            "description": "Signing algorithm (always Ed25519)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the key was created"
          },
          "is_active": {
            "type": "boolean",
            "description": "Whether the key is currently in use for new signatures"
          }
        },
        "required": ["key_id", "public_key", "algorithm", "created_at", "is_active"]
      },
      "IntegrityCertificate": {
        "type": "object",
        "description": "Machine-readable cryptographic certificate for an integrity checkpoint. Modeled on C2PA content credentials and W3C Verifiable Credentials.",
        "properties": {
          "@context": {
            "type": "string",
            "description": "Namespace identifier",
            "enum": ["https://mnemom.ai/aip/v1"]
          },
          "type": {
            "type": "string",
            "enum": ["IntegrityCertificate"]
          },
          "version": {
            "type": "string",
            "description": "Certificate format version"
          },
          "certificate_id": {
            "type": "string",
            "description": "Unique certificate identifier (cert-{8 random chars})"
          },
          "issued_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of certificate issuance"
          },
          "subject": {
            "type": "object",
            "description": "Identifies the checkpoint this certificate attests to",
            "properties": {
              "checkpoint_id": {
                "type": "string",
                "description": "Integrity checkpoint ID (ic-{uuid})"
              },
              "agent_id": {
                "type": "string"
              },
              "session_id": {
                "type": "string"
              },
              "card_id": {
                "type": "string"
              }
            },
            "required": ["checkpoint_id", "agent_id", "session_id", "card_id"]
          },
          "claims": {
            "type": "object",
            "description": "Analysis verdict and supporting evidence",
            "properties": {
              "verdict": {
                "type": "string",
                "enum": ["clear", "review_needed", "boundary_violation"]
              },
              "concerns": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "category": {
                      "type": "string"
                    },
                    "severity": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    }
                  }
                }
              },
              "confidence": {
                "type": "number",
                "description": "Extraction confidence (0.0-1.0)"
              },
              "reasoning_summary": {
                "type": "string"
              },
              "analysis_model": {
                "type": "string"
              },
              "analysis_duration_ms": {
                "type": "number"
              }
            }
          },
          "input_commitments": {
            "type": "object",
            "description": "Cryptographic commitments to analysis inputs",
            "properties": {
              "thinking_block_hash": {
                "type": "string",
                "description": "SHA-256 hash of the thinking block"
              },
              "card_hash": {
                "type": "string",
                "description": "SHA-256 hash of the Alignment Card"
              },
              "values_hash": {
                "type": "string",
                "description": "SHA-256 hash of conscience values"
              },
              "context_hash": {
                "type": "string",
                "description": "SHA-256 hash of window context"
              },
              "model_version": {
                "type": "string"
              },
              "combined_commitment": {
                "type": "string",
                "description": "SHA-256 of all input fields concatenated"
              }
            }
          },
          "proofs": {
            "type": "object",
            "description": "Cryptographic evidence supporting the claims",
            "properties": {
              "signature": {
                "type": "object",
                "properties": {
                  "algorithm": {
                    "type": "string",
                    "enum": ["Ed25519"]
                  },
                  "key_id": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string",
                    "description": "Base64-encoded Ed25519 signature"
                  },
                  "signed_payload": {
                    "type": "string",
                    "description": "Deterministic JSON string that was signed"
                  }
                }
              },
              "chain": {
                "type": "object",
                "properties": {
                  "chain_hash": {
                    "type": "string"
                  },
                  "prev_chain_hash": {
                    "type": ["string", "null"]
                  },
                  "position": {
                    "type": "integer"
                  }
                }
              },
              "merkle": {
                "type": ["object", "null"],
                "description": "Merkle inclusion proof. Null if not yet added to tree.",
                "properties": {
                  "leaf_hash": {
                    "type": "string"
                  },
                  "leaf_index": {
                    "type": "integer"
                  },
                  "root": {
                    "type": "string"
                  },
                  "tree_size": {
                    "type": "integer"
                  },
                  "inclusion_proof": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "hash": {
                          "type": "string"
                        },
                        "position": {
                          "type": "string",
                          "enum": ["left", "right"]
                        }
                      }
                    }
                  }
                }
              },
              "verdict_derivation": {
                "type": ["object", "null"],
                "description": "RISC Zero STARK proof. Null if not yet proven.",
                "properties": {
                  "method": {
                    "type": "string",
                    "enum": ["RISC-Zero-STARK"]
                  },
                  "image_id": {
                    "type": "string"
                  },
                  "receipt": {
                    "type": "string",
                    "description": "Base64-encoded STARK proof receipt"
                  },
                  "journal": {
                    "type": "string",
                    "description": "Base64-encoded public journal"
                  },
                  "verified_at": {
                    "type": "string",
                    "format": "date-time"
                  }
                }
              }
            }
          },
          "verification": {
            "type": "object",
            "description": "URLs for independent verification",
            "properties": {
              "keys_url": {
                "type": "string",
                "format": "uri"
              },
              "certificate_url": {
                "type": "string",
                "format": "uri"
              },
              "verify_url": {
                "type": "string",
                "format": "uri"
              }
            }
          }
        },
        "required": ["@context", "type", "version", "certificate_id", "issued_at", "subject", "claims", "input_commitments", "proofs", "verification"]
      },
      "MerkleRootResponse": {
        "type": "object",
        "description": "Current Merkle tree root and metadata for an agent",
        "properties": {
          "agent_id": {
            "type": "string",
            "description": "The agent ID"
          },
          "merkle_root": {
            "type": "string",
            "description": "SHA-256 Merkle root hash (hex-encoded)"
          },
          "tree_depth": {
            "type": "integer",
            "description": "Depth of the Merkle tree (ceil(log2(leaf_count)))"
          },
          "leaf_count": {
            "type": "integer",
            "description": "Total number of checkpoint leaves in the tree"
          },
          "last_updated": {
            "type": "string",
            "format": "date-time",
            "description": "When the tree was last updated"
          }
        },
        "required": ["agent_id", "merkle_root", "tree_depth", "leaf_count", "last_updated"]
      },
      "InclusionProofResponse": {
        "type": "object",
        "description": "Merkle inclusion proof for a checkpoint",
        "properties": {
          "checkpoint_id": {
            "type": "string",
            "description": "The checkpoint ID"
          },
          "leaf_hash": {
            "type": "string",
            "description": "SHA-256 leaf hash of this checkpoint"
          },
          "leaf_index": {
            "type": "integer",
            "description": "Index of this leaf in the tree"
          },
          "siblings": {
            "type": "array",
            "description": "O(log N) sibling hashes for proof verification",
            "items": {
              "type": "object",
              "properties": {
                "hash": {
                  "type": "string",
                  "description": "Hex-encoded sibling hash"
                },
                "position": {
                  "type": "string",
                  "enum": ["left", "right"],
                  "description": "Position of sibling relative to the path node"
                }
              },
              "required": ["hash", "position"]
            }
          },
          "root": {
            "type": "string",
            "description": "Current Merkle root (hex-encoded)"
          },
          "tree_size": {
            "type": "integer",
            "description": "Total number of leaves in the tree"
          },
          "verified": {
            "type": "boolean",
            "description": "Whether the proof was verified against the stored root"
          }
        },
        "required": ["checkpoint_id", "leaf_hash", "leaf_index", "siblings", "root", "tree_size", "verified"]
      },
      "ProofStatusResponse": {
        "type": "object",
        "description": "ZK proof status and metadata for a checkpoint",
        "properties": {
          "proof_id": {
            "type": "string",
            "description": "Proof identifier (prf-{8 random chars})"
          },
          "checkpoint_id": {
            "type": "string",
            "description": "The checkpoint this proof is for"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "proving", "completed", "failed"],
            "description": "Current proof status"
          },
          "proof_type": {
            "type": "string",
            "description": "Proof system (e.g., risc-zero-stark)"
          },
          "image_id": {
            "type": ["string", "null"],
            "description": "Guest program image ID (set when proving begins)"
          },
          "proving_duration_ms": {
            "type": ["integer", "null"],
            "description": "Wall-clock proving time in milliseconds (set when completed)"
          },
          "verified": {
            "type": "boolean",
            "description": "Whether the proof has been verified"
          },
          "verified_at": {
            "type": ["string", "null"],
            "format": "date-time",
            "description": "When the proof was verified (null if not yet verified)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the proof request was created"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the proof record was last updated"
          }
        },
        "required": ["proof_id", "checkpoint_id", "status", "proof_type", "verified", "created_at", "updated_at"]
      },
      "VerifyCertificateResponse": {
        "type": "object",
        "description": "Result of certificate verification",
        "properties": {
          "valid": {
            "type": "boolean",
            "description": "Whether all verification checks passed"
          },
          "checks": {
            "type": "object",
            "description": "Individual verification check results",
            "properties": {
              "signature": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "key_id": {
                    "type": "string"
                  }
                },
                "required": ["valid", "key_id"]
              },
              "chain": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "chain_hash": {
                    "type": "string"
                  }
                },
                "required": ["valid", "chain_hash"]
              },
              "merkle": {
                "type": ["object", "null"],
                "description": "Null if Merkle proof was not present in the certificate",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "root": {
                    "type": "string"
                  }
                }
              },
              "input_commitment": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "commitment": {
                    "type": "string"
                  }
                },
                "required": ["valid", "commitment"]
              },
              "verdict_derivation": {
                "type": ["object", "null"],
                "description": "Null if verdict derivation proof was not present",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "method": {
                    "type": "string"
                  }
                }
              }
            },
            "required": ["signature", "chain", "input_commitment"]
          },
          "details": {
            "type": "string",
            "description": "Semicolon-separated human-readable verification details"
          }
        },
        "required": ["valid", "checks", "details"]
      },
      "ErrorResponse": {
        "type": "object",
        "description": "Standard error response",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message"
          }
        },
        "required": ["error"]
      },
      "OrgConscienceValue": {
        "type": "object",
        "description": "A custom conscience value for an organization",
        "properties": {
          "id": {"type": "string", "description": "Value ID (cv-xxx)"},
          "org_id": {"type": "string"},
          "name": {"type": "string", "maxLength": 50},
          "description": {"type": "string", "maxLength": 500},
          "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
          "severity": {"type": "string", "enum": ["advisory", "mandatory"]},
          "scope": {"type": "string"},
          "is_active": {"type": "boolean"},
          "sort_order": {"type": "integer"},
          "created_by": {"type": "string"},
          "updated_by": {"type": "string"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        },
        "required": ["id", "org_id", "name", "description", "type", "severity"]
      },
      "OrgConscienceAuditEntry": {
        "type": "object",
        "description": "Audit log entry for conscience value changes",
        "properties": {
          "id": {"type": "string"},
          "org_id": {"type": "string"},
          "value_id": {"type": ["string", "null"]},
          "action": {"type": "string", "enum": ["create", "update", "delete", "activate", "deactivate", "reorder", "mode_change"]},
          "actor": {"type": "string"},
          "changes": {"type": "object"},
          "metadata": {"type": "object"},
          "created_at": {"type": "string", "format": "date-time"}
        },
        "required": ["id", "org_id", "action", "actor", "created_at"]
      },
      "OrgCardTemplate": {
        "type": "object",
        "description": "Organization alignment card template that all agents inherit",
        "properties": {
          "org_id": {"type": "string", "description": "Organization ID"},
          "enabled": {"type": "boolean", "description": "Whether the template is active"},
          "template": {"$ref": "#/components/schemas/AlignmentCard", "description": "The alignment card template JSON"},
          "created_by": {"type": "string", "description": "User ID who created the template"},
          "updated_by": {"type": "string", "description": "User ID who last updated the template"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        },
        "required": ["org_id", "enabled", "template"]
      }
    }
  }
}