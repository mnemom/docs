{
  "openapi": "3.1.0",
  "info": {
    "title": "Mnemom API",
    "version": "1.0.0",
    "description": "Trust infrastructure for AI agents. Transparent alignment verification, behavioral drift detection, and accountability protocols.",
    "contact": {
      "name": "Mnemom",
      "url": "https://mnemom.ai"
    },
    "license": {
      "name": "Apache 2.0",
      "url": "https://www.apache.org/licenses/LICENSE-2.0"
    }
  },
  "servers": [
    {
      "url": "https://api.mnemom.ai/v1",
      "description": "Production"
    }
  ],
  "tags": [
    {
      "name": "Agents",
      "description": "Agent CRUD, alignment card, claim, and link operations"
    },
    {
      "name": "Traces",
      "description": "Query and retrieve alignment protocol traces"
    },
    {
      "name": "Integrity",
      "description": "AAP integrity score, AIP integrity score, SSM similarity"
    },
    {
      "name": "Checkpoints",
      "description": "AIP integrity checkpoints: list, get, reverify"
    },
    {
      "name": "Drift",
      "description": "AAP drift alerts and AIP drift alerts"
    },
    {
      "name": "Enforcement",
      "description": "Enforcement mode get/set, conscience values CRUD, resolutions"
    },
    {
      "name": "Webhooks",
      "description": "AIP webhook registration and management"
    },
    {
      "name": "Auth",
      "description": "User authentication, profile, account deletion, SSO domain check"
    },
    {
      "name": "Billing",
      "description": "Checkout, portal, subscription, cancel, reactivate, change-plan, invoices, usage, budget alerts, promo validation, API keys, plans, features, enterprise contact"
    },
    {
      "name": "Organizations",
      "description": "Organization CRUD, members, invitations, agents, API keys, SSO configuration"
    },
    {
      "name": "Admin",
      "description": "Admin stats, usage, users, agents, costs, revenue, customers, licenses, coupons, exports, impersonation, suspend/unsuspend"
    },
    {
      "name": "Licensing",
      "description": "License validation (public) and admin license CRUD"
    },
    {
      "name": "Analyze",
      "description": "Single and batch integrity analysis via API key"
    },
    {
      "name": "Blog",
      "description": "Blog posts listing, retrieval, creation, and author profiles"
    },
    {
      "name": "Webhook Notifications",
      "description": "Organization-level webhook endpoints for real-time HTTP POST notifications of integrity, drift, conscience, and billing events"
    },
    {
      "name": "Verification",
      "description": "Public cryptographic verification endpoints for integrity certificates, Merkle proofs, signing keys, and ZK verdict proofs"
    },
    {
      "name": "Agent Containment",
      "description": "Pause, resume, kill, and reactivate agents. Manage auto-containment policies and view containment audit logs."
    },
    {
      "name": "Conscience Values",
      "description": "Per-org custom conscience values for alignment policy injection (Enterprise)"
    },
    {
      "name": "Card Templates",
      "description": "Organization-level alignment card templates that all agents inherit (Enterprise)"
    },
    {
      "name": "Teams",
      "description": "Team CRUD, member management, roster history, and team alignment cards"
    },
    {
      "name": "Team Reputation",
      "description": "Team reputation scores, history, cryptographic verification, and embeddable badges"
    },
    {
      "name": "Policy",
      "description": "Policy management endpoints for agents and organizations. Define capability mappings, forbidden tools, escalation triggers, and enforcement defaults."
    },
    {
      "name": "Reclassification",
      "description": "Violation reclassification and trust recovery. Reclassify checkpoint violations, trigger score recomputation, and export compliance records."
    },
    {
      "name": "Intelligence",
      "description": "Fault line analysis, risk forecasting, and policy recommendations. Analyze team alignment gaps, forecast failure modes, and generate policy suggestions."
    },
    {
      "name": "On-Chain",
      "description": "On-chain Merkle root anchoring and score publishing. Anchor integrity proofs to blockchain, publish scores, and verify on-chain proofs."
    }
  ],
  "security": [{"BearerAuth": []}],
  "paths": {
    "/agents/{agent_id}": {
      "get": {
        "operationId": "getAgent",
        "summary": "Get agent by ID",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Agent details. Private agents return a limited response to non-owners.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Agent"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/card": {
      "get": {
        "operationId": "getAgentCard",
        "summary": "Get active alignment card for agent",
        "tags": [
          "Agents"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Active alignment card",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AlignmentCard"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateAgentCard",
        "summary": "Update alignment card",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nUpdate the alignment card for an agent.",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "ServiceRole": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "card_json": {
                    "$ref": "#/components/schemas/AlignmentCard"
                  },
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Card updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "updated": {
                      "type": "boolean"
                    },
                    "card_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/agents/{agent_id}/claim": {
      "post": {
        "operationId": "claimAgent",
        "summary": "Claim agent with hash proof",
        "tags": [
          "Agents"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "hash_proof"
                ],
                "properties": {
                  "hash_proof": {
                    "type": "string",
                    "description": "SHA-256 hash of agent API key"
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent claimed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "claimed": {
                      "type": "boolean"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "claimed_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "409": {
            "description": "Agent already claimed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/link": {
      "post": {
        "operationId": "linkAgent",
        "summary": "Link claimed agent to authenticated user",
        "tags": [
          "Agents"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "hash_proof"
                ],
                "properties": {
                  "hash_proof": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent linked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "linked": {
                      "type": "boolean"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "409": {
            "description": "Agent already linked to another account",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/traces": {
      "get": {
        "operationId": "getAgentTraces",
        "summary": "Get traces for agent (AAP query alias)",
        "tags": [
          "Traces"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "traces": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/APTrace"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/traces": {
      "get": {
        "operationId": "queryTraces",
        "summary": "Query traces with filters",
        "tags": [
          "Traces"
        ],
        "security": [
          {
            "BearerAuth": []
          },
          {}
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Filtered list of traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "traces": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/APTrace"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/traces/{trace_id}": {
      "get": {
        "operationId": "getTrace",
        "summary": "Get single trace by ID",
        "tags": [
          "Traces"
        ],
        "parameters": [
          {
            "name": "trace_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Trace details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/APTrace"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/integrity/{agent_id}": {
      "get": {
        "operationId": "getIntegrityScore",
        "summary": "Compute AAP integrity score",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Integrity score",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/IntegrityScore"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/integrity/aip": {
      "get": {
        "operationId": "getAipIntegrityScore",
        "summary": "AIP integrity score",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "AIP integrity score",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "total_checks": {
                      "type": "integer"
                    },
                    "clear_count": {
                      "type": "integer"
                    },
                    "review_count": {
                      "type": "integer"
                    },
                    "violation_count": {
                      "type": "integer"
                    },
                    "integrity_ratio": {
                      "type": "number"
                    },
                    "latest_verdict": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/ssm/{agent_id}": {
      "get": {
        "operationId": "getSSM",
        "summary": "Get traces with semantic similarity scores",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Traces with similarity scores",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "trace_count": {
                      "type": "integer"
                    },
                    "traces": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/ssm/{agent_id}/timeline": {
      "get": {
        "operationId": "getSSMTimeline",
        "summary": "Get similarity timeline data",
        "tags": [
          "Integrity"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 7,
              "minimum": 1,
              "maximum": 30
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Similarity timeline",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "days": {
                      "type": "integer"
                    },
                    "timeline": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "date": {
                            "type": "string",
                            "format": "date"
                          },
                          "trace_count": {
                            "type": "integer"
                          },
                          "avg_similarity": {
                            "type": "number"
                          },
                          "values_used": {
                            "type": "object",
                            "additionalProperties": {
                              "type": "integer"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/checkpoints": {
      "get": {
        "operationId": "listCheckpoints",
        "summary": "Paginated integrity checkpoints",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 1000
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          },
          {
            "name": "verdict",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "clear",
                "review_needed",
                "boundary_violation"
              ]
            }
          },
          {
            "name": "session_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated checkpoints",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "checkpoints": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Checkpoint"
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/checkpoints/{checkpoint_id}": {
      "get": {
        "operationId": "getCheckpoint",
        "summary": "Get single checkpoint",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Checkpoint details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Checkpoint"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/reverify": {
      "post": {
        "operationId": "reverifyTraces",
        "summary": "Re-verify AAP traces against updated card",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 40,
              "maximum": 40
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Re-verification results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "card_id": {
                      "type": "string"
                    },
                    "total_traces_in_batch": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "reverified": {
                      "type": "integer"
                    },
                    "still_violating": {
                      "type": "integer"
                    },
                    "now_clean": {
                      "type": "integer"
                    },
                    "errors": {
                      "type": [
                        "array",
                        "null"
                      ],
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/reverify/aip": {
      "post": {
        "operationId": "reverifyAipCheckpoints",
        "summary": "Re-evaluate AIP checkpoints against updated card",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 20
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Re-evaluation results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "card_id": {
                      "type": "string"
                    },
                    "total_in_batch": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "re_evaluated": {
                      "type": "integer"
                    },
                    "resolved_to_clear": {
                      "type": "integer"
                    },
                    "kept_non_clear": {
                      "type": "integer"
                    },
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "errors": {
                      "type": [
                        "array",
                        "null"
                      ],
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/drift/{agent_id}": {
      "get": {
        "operationId": "getAapDrift",
        "summary": "Get AAP drift alerts for agent",
        "tags": [
          "Drift"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Drift detection results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "analyzed_traces": {
                      "type": "integer"
                    },
                    "drift": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/drift/aip": {
      "get": {
        "operationId": "getAipDrift",
        "summary": "Get AIP drift alerts",
        "tags": [
          "Drift"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "AIP drift alerts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "alerts": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/DriftAlert"
                      }
                    },
                    "agent_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/timeline": {
      "get": {
        "operationId": "getTimeline",
        "summary": "Unified dual-rail AIP + AAP timeline",
        "tags": [
          "Checkpoints"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "maximum": 200
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Timeline events",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "summary": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/enforcement": {
      "get": {
        "operationId": "getEnforcement",
        "summary": "Get AIP enforcement mode",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Enforcement mode",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnforcementMode"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "setEnforcement",
        "summary": "Update AIP enforcement mode",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "mode"
                ],
                "properties": {
                  "mode": {
                    "type": "string",
                    "enum": [
                      "observe",
                      "enforce",
                      "nudge"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Enforcement mode updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "enforcement_mode": {
                      "type": "string"
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/conscience-values": {
      "get": {
        "operationId": "getConscienceValues",
        "summary": "Get conscience values for agent",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Conscience values",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "conscience_values": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ConscienceValue"
                      }
                    },
                    "is_default": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "updateConscienceValues",
        "summary": "Update conscience values",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "conscience_values"
                ],
                "properties": {
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Values updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "conscience_values": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ConscienceValue"
                      }
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "resetConscienceValues",
        "summary": "Reset conscience values to defaults",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "Values reset to defaults",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {
                      "type": "string"
                    },
                    "reset_to_defaults": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/agents/{agent_id}/resolve": {
      "post": {
        "operationId": "resolveViolation",
        "summary": "Resolve a concern or violation",
        "tags": [
          "Enforcement"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "target_type",
                  "target_id",
                  "resolution_type"
                ],
                "properties": {
                  "target_type": {
                    "type": "string",
                    "enum": [
                      "checkpoint",
                      "trace"
                    ]
                  },
                  "target_id": {
                    "type": "string"
                  },
                  "resolution_type": {
                    "type": "string",
                    "enum": [
                      "acknowledged",
                      "allow_action",
                      "add_value"
                    ]
                  },
                  "action_name": {
                    "type": "string",
                    "description": "Required when resolution_type is allow_action"
                  },
                  "value_name": {
                    "type": "string",
                    "description": "Required when resolution_type is add_value"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resolution created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "resolution_id": {
                      "type": "string"
                    },
                    "resolution_type": {
                      "type": "string"
                    },
                    "resolved_by": {
                      "type": "string"
                    },
                    "card_modified": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "409": {
            "description": "Resolution already exists",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/agents/{agent_id}/resolutions": {
      "get": {
        "operationId": "listResolutions",
        "summary": "List resolutions for an agent",
        "tags": [
          "Enforcement"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/AgentId"
          }
        ],
        "responses": {
          "200": {
            "description": "List of resolutions",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "resolutions": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/aip/webhooks": {
      "post": {
        "operationId": "registerAipWebhook",
        "summary": "Register AIP webhook",
        "tags": [
          "Webhooks"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "agent_id",
                  "callback_url",
                  "secret",
                  "events"
                ],
                "properties": {
                  "agent_id": {
                    "type": "string"
                  },
                  "callback_url": {
                    "type": "string",
                    "format": "uri"
                  },
                  "secret": {
                    "type": "string"
                  },
                  "events": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Webhook registered",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "registration_id": {
                      "type": "string"
                    },
                    "agent_id": {
                      "type": "string"
                    },
                    "callback_url": {
                      "type": "string"
                    },
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/aip/webhooks/{registration_id}": {
      "delete": {
        "operationId": "deleteAipWebhook",
        "summary": "Remove AIP webhook",
        "tags": [
          "Webhooks"
        ],
        "parameters": [
          {
            "name": "registration_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Webhook deleted"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/auth/me": {
      "get": {
        "operationId": "getMe",
        "summary": "Get authenticated user info and linked agents",
        "tags": [
          "Auth"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User profile",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "user_id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "agents": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Agent"
                      }
                    },
                    "billing_account_id": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "plan_id": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "org": {
                      "type": [
                        "object",
                        "null"
                      ],
                      "properties": {
                        "org_id": {
                          "type": "string"
                        },
                        "org_name": {
                          "type": "string"
                        },
                        "role": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/auth/delete-account": {
      "delete": {
        "operationId": "deleteAccount",
        "summary": "Delete authenticated user account and unlink agents",
        "tags": [
          "Auth"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Account deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/auth/sso/check-domain": {
      "get": {
        "operationId": "checkSsoDomain",
        "summary": "Check if email domain has SSO enabled",
        "tags": [
          "Auth"
        ],
        "parameters": [
          {
            "name": "email",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "email"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "SSO domain check result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "sso_enabled": {
                      "type": "boolean"
                    },
                    "org_id": {
                      "type": "string"
                    },
                    "org_name": {
                      "type": "string"
                    },
                    "provider_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/billing/checkout": {
      "post": {
        "operationId": "createCheckout",
        "summary": "Create Stripe checkout session",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "plan_id"
                ],
                "properties": {
                  "plan_id": {
                    "type": "string"
                  },
                  "annual": {
                    "type": "boolean",
                    "default": false
                  },
                  "promo_code": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Checkout session URL",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "url": {
                      "type": "string"
                    },
                    "session_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/portal": {
      "post": {
        "operationId": "createPortalSession",
        "summary": "Create Stripe billing portal session",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Portal session URL",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/subscription": {
      "get": {
        "operationId": "getSubscription",
        "summary": "Get current subscription details",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Subscription details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Subscription"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/cancel": {
      "post": {
        "operationId": "cancelSubscription",
        "summary": "Cancel subscription at period end",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Cancellation confirmed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "canceled": {
                      "type": "boolean"
                    },
                    "cancel_at_period_end": {
                      "type": "boolean"
                    },
                    "current_period_end": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/reactivate": {
      "post": {
        "operationId": "reactivateSubscription",
        "summary": "Reactivate a subscription scheduled for cancellation",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Reactivation confirmed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reactivated": {
                      "type": "boolean"
                    },
                    "cancel_at_period_end": {
                      "type": "boolean"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/change-plan": {
      "post": {
        "operationId": "changePlan",
        "summary": "Change subscription plan",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "plan_id"
                ],
                "properties": {
                  "plan_id": {
                    "type": "string"
                  },
                  "annual": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Plan changed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "updated": {
                      "type": "boolean"
                    },
                    "plan_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/invoices": {
      "get": {
        "operationId": "listInvoices",
        "summary": "List invoices",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Invoice list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "invoices": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Invoice"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/me": {
      "get": {
        "operationId": "getMyBilling",
        "summary": "Get authenticated user billing summary",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Billing summary",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/features": {
      "get": {
        "operationId": "getFeatures",
        "summary": "Get plan feature flags for authenticated user",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Plan features",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plan_id": {
                      "type": "string"
                    },
                    "feature_flags": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "boolean"
                      }
                    },
                    "limits": {
                      "type": "object"
                    },
                    "included_checks": {
                      "type": "integer"
                    },
                    "check_count_this_period": {
                      "type": "integer"
                    },
                    "subscription_status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/usage": {
      "get": {
        "operationId": "getMyUsage",
        "summary": "Get usage metrics for current user",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 30,
              "minimum": 1,
              "maximum": 90
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Usage data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UsageMetrics"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/usage/agents": {
      "get": {
        "operationId": "getMyAgentUsage",
        "summary": "Get per-agent usage breakdown",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "days",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 30,
              "minimum": 1,
              "maximum": 90
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Per-agent usage data",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/budget-alert": {
      "get": {
        "operationId": "getBudgetAlert",
        "summary": "Get budget alert settings",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Budget alert settings",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "threshold_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "last_alert_sent_at": {
                      "type": [
                        "string",
                        "null"
                      ],
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      },
      "put": {
        "operationId": "setBudgetAlert",
        "summary": "Set budget alert threshold",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "threshold_cents": {
                    "type": [
                      "integer",
                      "null"
                    ],
                    "minimum": 0
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Budget alert updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "threshold_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "updated": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/export/usage": {
      "get": {
        "operationId": "exportUsage",
        "summary": "Export usage data as CSV",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "from",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Start date (YYYY-MM-DD)"
          },
          {
            "name": "to",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "End date (YYYY-MM-DD)"
          }
        ],
        "responses": {
          "200": {
            "description": "CSV file",
            "content": {
              "text/csv": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/billing/validate-promo": {
      "post": {
        "operationId": "validatePromo",
        "summary": "Validate a promo code",
        "tags": [
          "Billing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "code"
                ],
                "properties": {
                  "code": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Promo validation result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "discount_percent": {
                      "type": [
                        "number",
                        "null"
                      ]
                    },
                    "discount_amount_cents": {
                      "type": [
                        "integer",
                        "null"
                      ]
                    },
                    "name": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/enterprise/contact": {
      "post": {
        "operationId": "enterpriseContact",
        "summary": "Submit enterprise contact form",
        "tags": [
          "Billing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "email",
                  "company"
                ],
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "company": {
                    "type": "string"
                  },
                  "role": {
                    "type": "string"
                  },
                  "company_size": {
                    "type": "string"
                  },
                  "message": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Inquiry submitted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/plans": {
      "get": {
        "operationId": "listPublicPlans",
        "summary": "List public pricing plans",
        "tags": [
          "Billing"
        ],
        "responses": {
          "200": {
            "description": "Public plans",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plans": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Plan"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      }
    },
    "/api-keys": {
      "post": {
        "operationId": "createApiKey",
        "summary": "Create a personal API key",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "maxLength": 100,
                    "default": "Default"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "API key created (secret shown once)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiKey"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      },
      "get": {
        "operationId": "listApiKeys",
        "summary": "List active API keys",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "API key list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ApiKey"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/api-keys/{key_id}": {
      "delete": {
        "operationId": "revokeApiKey",
        "summary": "Revoke an API key",
        "tags": [
          "Billing"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "key_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Key revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "key_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs": {
      "post": {
        "operationId": "createOrg",
        "summary": "Create organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "slug"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 2,
                    "maxLength": 100
                  },
                  "slug": {
                    "type": "string",
                    "minLength": 3,
                    "maxLength": 48,
                    "pattern": "^[a-z0-9][a-z0-9-]*[a-z0-9]$"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Organization created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "409": {
            "description": "Slug taken or user already in org",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      },
      "get": {
        "operationId": "listMyOrgs",
        "summary": "List organizations for authenticated user",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Organizations list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "orgs": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Organization"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/orgs/{org_id}": {
      "get": {
        "operationId": "getOrg",
        "summary": "Get organization details",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateOrg",
        "summary": "Update organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "slug": {
                    "type": "string"
                  },
                  "billing_email": {
                    "type": "string"
                  },
                  "company_name": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Organization updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Organization"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "deleteOrg",
        "summary": "Delete organization (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/members": {
      "get": {
        "operationId": "listMembers",
        "summary": "List organization members",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Members list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "members": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/OrgMember"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/members/{user_id}": {
      "patch": {
        "operationId": "updateMemberRole",
        "summary": "Update member role (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "role"
                ],
                "properties": {
                  "role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Role updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    },
                    "old_role": {
                      "type": "string"
                    },
                    "new_role": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "removeMember",
        "summary": "Remove member or self-leave",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Member removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "removed": {
                      "type": "boolean"
                    },
                    "org_id": {
                      "type": "string"
                    },
                    "user_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/invitations": {
      "post": {
        "operationId": "inviteMember",
        "summary": "Invite member to organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ],
                    "default": "member"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Invitation created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgInvitation"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "get": {
        "operationId": "listInvitations",
        "summary": "List pending invitations",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Invitations list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "invitations": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/OrgInvitation"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/invitations/{invitation_id}": {
      "delete": {
        "operationId": "revokeInvitation",
        "summary": "Revoke a pending invitation",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "invitation_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Invitation revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "invitation_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/invitations/accept": {
      "post": {
        "operationId": "acceptInvitation",
        "summary": "Accept an organization invitation",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "token"
                ],
                "properties": {
                  "token": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Invitation accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {
                      "type": "string"
                    },
                    "org_name": {
                      "type": "string"
                    },
                    "role": {
                      "type": "string"
                    },
                    "personal_subscription_warning": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          }
        }
      }
    },
    "/orgs/{org_id}/agents": {
      "get": {
        "operationId": "getOrgAgents",
        "summary": "List agents in organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "mine",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "Filter to only current user's agents"
          }
        ],
        "responses": {
          "200": {
            "description": "Organization agents",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agents": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Agent"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/pause": {
      "post": {
        "operationId": "pauseAgent",
        "summary": "Pause an agent",
        "description": "Temporarily stop an agent from making API requests. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Reason for pausing the agent"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent paused successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["paused"]},
                    "contained_at": {"type": "string", "format": "date-time"},
                    "contained_by": {"type": "string"},
                    "containment_reason": {"type": "string", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is already paused"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/resume": {
      "post": {
        "operationId": "resumeAgent",
        "summary": "Resume a paused agent",
        "description": "Resume a paused agent back to active state. Only works on paused agents. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Agent resumed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["active"]}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is not paused"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/kill": {
      "post": {
        "operationId": "killAgent",
        "summary": "Kill an agent",
        "description": "Permanently stop an agent. Requires explicit reactivation to restore. Owner only.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Reason for killing the agent"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Agent killed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["killed"]},
                    "contained_at": {"type": "string", "format": "date-time"},
                    "contained_by": {"type": "string"},
                    "containment_reason": {"type": "string", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is already killed"},
          "403": {"description": "Insufficient permissions - owner only"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/reactivate": {
      "post": {
        "operationId": "reactivateAgent",
        "summary": "Reactivate a killed agent",
        "description": "Restore a killed agent back to active state. Owner only.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Agent reactivated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "containment_status": {"type": "string", "enum": ["active"]}
                  }
                }
              }
            }
          },
          "400": {"description": "Agent is not killed"},
          "403": {"description": "Insufficient permissions - owner only"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/containment": {
      "get": {
        "operationId": "getAgentContainment",
        "summary": "Get agent containment status",
        "description": "Returns the current containment status and recent audit log entries. Any org role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Containment status",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "status": {"type": "string", "enum": ["active", "paused", "killed"]},
                    "contained_at": {"type": "string", "format": "date-time", "nullable": true},
                    "contained_by": {"type": "string", "nullable": true},
                    "containment_reason": {"type": "string", "nullable": true},
                    "auto_containment_threshold": {"type": "integer", "nullable": true},
                    "log": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {"type": "string"},
                          "action": {"type": "string"},
                          "actor": {"type": "string"},
                          "reason": {"type": "string", "nullable": true},
                          "previous_status": {"type": "string"},
                          "new_status": {"type": "string"},
                          "created_at": {"type": "string", "format": "date-time"}
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/agents/{agent_id}/containment-policy": {
      "put": {
        "operationId": "updateContainmentPolicy",
        "summary": "Update auto-containment policy",
        "description": "Set or disable the auto-containment threshold. When set, the agent will be automatically paused after N consecutive boundary violations. Requires owner or admin role.",
        "tags": ["Agent Containment"],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "agent_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["auto_containment_threshold"],
                "properties": {
                  "auto_containment_threshold": {
                    "type": "integer",
                    "minimum": 2,
                    "nullable": true,
                    "description": "Number of consecutive boundary violations before auto-pause. Set to null to disable."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Policy updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "auto_containment_threshold": {"type": "integer", "nullable": true}
                  }
                }
              }
            }
          },
          "400": {"description": "Invalid threshold value"},
          "403": {"description": "Insufficient permissions"},
          "404": {"description": "Agent not found in organization"}
        },
        "security": [{"bearerAuth": []}]
      }
    },
    "/orgs/{org_id}/api-keys": {
      "post": {
        "operationId": "createOrgApiKey",
        "summary": "Create organization API key",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "maxLength": 100
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Org API key created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiKey"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "get": {
        "operationId": "listOrgApiKeys",
        "summary": "List organization API keys",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "Org API keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ApiKey"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/api-keys/{key_id}": {
      "delete": {
        "operationId": "revokeOrgApiKey",
        "summary": "Revoke organization API key",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "key_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Key revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "revoked": {
                      "type": "boolean"
                    },
                    "key_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/sso": {
      "get": {
        "operationId": "getSsoConfig",
        "summary": "Get SSO configuration for organization",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "SSO config or not configured",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "put": {
        "operationId": "configureSso",
        "summary": "Configure SAML SSO for organization (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "metadata_url",
                  "allowed_domains"
                ],
                "properties": {
                  "metadata_url": {
                    "type": "string",
                    "format": "uri"
                  },
                  "idp_name": {
                    "type": "string"
                  },
                  "default_role": {
                    "type": "string",
                    "enum": [
                      "admin",
                      "member",
                      "viewer",
                      "auditor"
                    ],
                    "default": "member"
                  },
                  "allowed_domains": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "minItems": 1
                  },
                  "enforced": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "SSO configured",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "removeSso",
        "summary": "Remove SSO configuration (owner only)",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "SSO removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "removed": {
                      "type": "boolean"
                    },
                    "note": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/sso/test": {
      "post": {
        "operationId": "testSso",
        "summary": "Test SSO metadata URL validity",
        "tags": [
          "Organizations"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metadata_url": {
                    "type": "string",
                    "format": "uri"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "SSO test result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "error": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "metadata_url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/license/validate": {
      "post": {
        "operationId": "validateLicense",
        "summary": "Validate a license key (public)",
        "tags": [
          "Licensing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "license",
                  "instance_id"
                ],
                "properties": {
                  "license": {
                    "type": "string",
                    "description": "License JWT token"
                  },
                  "instance_id": {
                    "type": "string",
                    "description": "Unique instance identifier"
                  },
                  "instance_metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "License valid",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {
                      "type": "boolean"
                    },
                    "license_id": {
                      "type": "string"
                    },
                    "plan_id": {
                      "type": "string"
                    },
                    "feature_flags": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "boolean"
                      }
                    },
                    "limits": {
                      "type": "object"
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "next_check_seconds": {
                      "type": "integer"
                    },
                    "warning": {
                      "type": [
                        "string",
                        "null"
                      ]
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Invalid license",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "License revoked",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "409": {
            "description": "Max activations exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "activation_count": {
                      "type": "integer"
                    },
                    "max_activations": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "410": {
            "description": "License expired",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/analyze": {
      "post": {
        "operationId": "analyze",
        "summary": "Run single integrity analysis",
        "tags": [
          "Analyze"
        ],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "thinking_block",
                  "thinking_metadata",
                  "agent_id",
                  "session_id",
                  "card"
                ],
                "properties": {
                  "thinking_block": {
                    "type": "string"
                  },
                  "thinking_metadata": {
                    "type": "object",
                    "required": [
                      "provider",
                      "model"
                    ],
                    "properties": {
                      "provider": {
                        "type": "string"
                      },
                      "model": {
                        "type": "string"
                      }
                    }
                  },
                  "agent_id": {
                    "type": "string"
                  },
                  "session_id": {
                    "type": "string"
                  },
                  "card": {
                    "type": "object",
                    "required": [
                      "card_id",
                      "values"
                    ],
                    "properties": {
                      "card_id": {
                        "type": "string"
                      },
                      "values": {
                        "type": "array",
                        "items": {
                          "type": "object"
                        }
                      }
                    }
                  },
                  "conscience_values": {
                    "type": "array",
                    "items": {
                      "$ref": "#/components/schemas/ConscienceValue"
                    }
                  },
                  "window_context": {
                    "type": "array",
                    "items": {
                      "type": "object"
                    }
                  },
                  "task_context": {
                    "type": "string"
                  },
                  "store_checkpoint": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Analysis result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "checkpoint": {
                      "$ref": "#/components/schemas/Checkpoint"
                    },
                    "proceed": {
                      "type": "boolean"
                    },
                    "recommended_action": {
                      "type": "string"
                    },
                    "window_summary": {
                      "type": "object"
                    },
                    "metering": {
                      "type": "object",
                      "properties": {
                        "event_id": {
                          "type": "string"
                        },
                        "account_id": {
                          "type": "string"
                        },
                        "billed": {
                          "type": "boolean"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "402": {
            "description": "Quota exceeded or account suspended",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/analyze/batch": {
      "post": {
        "operationId": "analyzeBatch",
        "summary": "Run batch integrity analysis (1-50 items)",
        "tags": [
          "Analyze"
        ],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "items"
                ],
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object"
                    },
                    "minItems": 1,
                    "maxItems": 50,
                    "description": "Array of analysis requests (same shape as POST /analyze body)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Batch analysis results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "metering": {
                      "type": "object",
                      "properties": {
                        "total_events": {
                          "type": "integer"
                        },
                        "account_id": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "402": {
            "description": "Quota exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/blog/posts": {
      "get": {
        "operationId": "listBlogPosts",
        "summary": "List published blog posts",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          },
          {
            "name": "agent_id",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Blog post list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "posts": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "limit": {
                      "type": "integer"
                    },
                    "offset": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          }
        }
      },
      "post": {
        "operationId": "createBlogPost",
        "summary": "Create blog post (service role only)",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nCreate a new blog post.",
        "tags": [
          "Blog"
        ],
        "security": [
          {
            "ServiceRole": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "agent_id",
                  "slug",
                  "title",
                  "body"
                ],
                "properties": {
                  "agent_id": {
                    "type": "string"
                  },
                  "slug": {
                    "type": "string",
                    "pattern": "^[a-z0-9-]+$"
                  },
                  "title": {
                    "type": "string"
                  },
                  "subtitle": {
                    "type": "string"
                  },
                  "body": {
                    "type": "string"
                  },
                  "tags": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "investigation_session_id": {
                    "type": "string"
                  },
                  "trace_ids": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "draft",
                      "published"
                    ],
                    "default": "draft"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Post created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "409": {
            "description": "Duplicate slug",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/blog/posts/{slug}": {
      "get": {
        "operationId": "getBlogPost",
        "summary": "Get single blog post by slug",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "slug",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Blog post with linked traces",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "post": {
                      "type": "object"
                    },
                    "linked_traces": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/blog/authors/{agent_id}": {
      "get": {
        "operationId": "getBlogAuthor",
        "summary": "Get author profile and their posts",
        "tags": [
          "Blog"
        ],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Author and posts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "author": {
                      "$ref": "#/components/schemas/Agent"
                    },
                    "posts": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks": {
      "post": {
        "operationId": "createWebhookEndpoint",
        "summary": "Create a webhook endpoint",
        "description": "Create a new webhook endpoint for the organization. Returns the signing secret (shown only once). Maximum 5 endpoints per organization.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["url"],
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "HTTPS URL that will receive webhook POST requests"
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable description of this endpoint"
                  },
                  "event_types": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["integrity.violation", "integrity.checkpoint", "drift.detected", "drift.resolved", "conscience.escalation", "quota.warning", "quota.exceeded", "subscription.status_changed"]
                    },
                    "description": "Event types to subscribe to. Empty array means all events."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Webhook endpoint created. Response includes signing_secret (shown only once).",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpoint"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      },
      "get": {
        "operationId": "listWebhookEndpoints",
        "summary": "List webhook endpoints",
        "description": "List all webhook endpoints for the organization. Signing secrets are not included.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          }
        ],
        "responses": {
          "200": {
            "description": "List of webhook endpoints",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/WebhookEndpointPublic"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}": {
      "get": {
        "operationId": "getWebhookEndpoint",
        "summary": "Get webhook endpoint details",
        "description": "Get details for a single webhook endpoint. Signing secret is not included.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Webhook endpoint details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpointPublic"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "patch": {
        "operationId": "updateWebhookEndpoint",
        "summary": "Update webhook endpoint",
        "description": "Update an existing webhook endpoint. Re-enabling a disabled endpoint resets the failure counter.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "New HTTPS URL"
                  },
                  "description": {
                    "type": "string"
                  },
                  "event_types": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["integrity.violation", "integrity.checkpoint", "drift.detected", "drift.resolved", "conscience.escalation", "quota.warning", "quota.exceeded", "subscription.status_changed"]
                    }
                  },
                  "is_active": {
                    "type": "boolean",
                    "description": "Set to true to re-enable a disabled endpoint (resets failure counter)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated endpoint",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WebhookEndpointPublic"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      },
      "delete": {
        "operationId": "deleteWebhookEndpoint",
        "summary": "Delete webhook endpoint",
        "description": "Permanently delete a webhook endpoint and all its delivery history.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Endpoint deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {
                      "type": "boolean"
                    },
                    "endpoint_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}/rotate-secret": {
      "post": {
        "operationId": "rotateWebhookSecret",
        "summary": "Rotate webhook signing secret",
        "description": "Generate a new signing secret for the endpoint. The new secret is returned once. Previous secret is immediately invalidated.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "New signing secret (shown only once)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "endpoint_id": {
                      "type": "string"
                    },
                    "signing_secret": {
                      "type": "string",
                      "description": "New 32-byte hex-encoded signing secret. Store securely  not retrievable again."
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/{endpoint_id}/test": {
      "post": {
        "operationId": "testWebhookEndpoint",
        "summary": "Send test webhook delivery",
        "description": "Send a synchronous test delivery to the endpoint with a synthetic webhook.test event. Returns the delivery result immediately.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "$ref": "#/components/parameters/EndpointId"
          }
        ],
        "responses": {
          "200": {
            "description": "Test delivery result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "status": {
                      "type": ["integer", "null"],
                      "description": "HTTP response status code from the endpoint"
                    },
                    "latency_ms": {
                      "type": ["integer", "null"],
                      "description": "Round-trip time in milliseconds"
                    },
                    "error": {
                      "type": ["string", "null"],
                      "description": "Error message if delivery failed"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/deliveries": {
      "get": {
        "operationId": "getWebhookDeliveryLog",
        "summary": "Get webhook delivery log",
        "description": "Paginated delivery log for the organization. Optionally filter by endpoint_id.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "endpoint_id",
            "in": "query",
            "schema": {
              "type": "string"
            },
            "description": "Filter deliveries to a specific endpoint"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "maximum": 100
            },
            "description": "Number of deliveries to return (max 100)"
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            },
            "description": "Offset for pagination"
          }
        ],
        "responses": {
          "200": {
            "description": "Delivery log entries",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/WebhookDelivery"
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/orgs/{org_id}/webhooks/deliveries/{delivery_id}/redeliver": {
      "post": {
        "operationId": "redeliverWebhookEvent",
        "summary": "Redeliver a webhook event",
        "description": "Create a new delivery attempt for a previously failed event. A new delivery row is created with next_attempt_at set to now.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/OrgId"
          },
          {
            "name": "delivery_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Delivery identifier (e.g. whd-abc12345)"
          }
        ],
        "responses": {
          "201": {
            "description": "New delivery created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "delivery_id": {
                      "type": "string"
                    },
                    "event_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["pending"]
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    },
    "/admin/webhooks/health": {
      "get": {
        "operationId": "adminWebhookHealth",
        "summary": "Get platform-wide webhook health metrics",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nAdmin-only endpoint returning active endpoints count, 24h success rate, disabled endpoints, and top event types.",
        "tags": [
          "Webhook Notifications"
        ],
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Webhook health metrics",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "active_endpoints": {
                      "type": "integer"
                    },
                    "disabled_endpoints": {
                      "type": "integer"
                    },
                    "deliveries_24h": {
                      "type": "integer"
                    },
                    "success_24h": {
                      "type": "integer"
                    },
                    "failed_24h": {
                      "type": "integer"
                    },
                    "success_rate_24h": {
                      "type": "number"
                    },
                    "top_event_types": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "event_type": {
                            "type": "string"
                          },
                          "count": {
                            "type": "integer"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          }
        }
      }
    },
    "/v1/keys": {
      "get": {
        "operationId": "getSigningKeys",
        "summary": "List signing keys",
        "description": "List all active Ed25519 signing public keys. Public endpoint, no authentication required. These keys are used to verify IntegrityCertificate signatures.",
        "tags": ["Verification"],
        "security": [{}],
        "responses": {
          "200": {
            "description": "List of active signing keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/SigningKeyInfo"
                      }
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/verify": {
      "post": {
        "operationId": "verifyCertificate",
        "summary": "Verify certificate",
        "description": "Verify an IntegrityCertificate. Performs Ed25519 signature verification, chain hash verification, Merkle inclusion proof verification, input commitment check, and optional STARK proof verification. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["certificate"],
                "properties": {
                  "certificate": {
                    "$ref": "#/components/schemas/IntegrityCertificate"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Verification result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/VerifyCertificateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request body or certificate structure",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/certificate": {
      "get": {
        "operationId": "getCheckpointCertificate",
        "summary": "Get integrity certificate",
        "description": "Retrieve or reconstruct the IntegrityCertificate for a checkpoint. Includes signature, chain proof, Merkle inclusion proof (if available), and verdict derivation proof (if completed). Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "The integrity certificate",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/IntegrityCertificate"
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found or certificate not available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/inclusion-proof": {
      "get": {
        "operationId": "getInclusionProof",
        "summary": "Get inclusion proof",
        "description": "Generate and return a Merkle inclusion proof for a checkpoint. The proof contains O(log N) sibling hashes sufficient to recompute the Merkle root, proving the checkpoint is included in the agent's complete checkpoint history. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "Merkle inclusion proof",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InclusionProofResponse"
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found or no Merkle proof available",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "422": {
            "description": "Merkle leaf index out of bounds",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/prove": {
      "post": {
        "operationId": "requestZkProof",
        "summary": "Request ZK proof",
        "description": "Request a zero-knowledge proof for a checkpoint's verdict derivation. If a proof already exists, returns its current status. Otherwise, creates a pending proof request and dispatches it to the SP1 prover service. Requires API key authentication.",
        "tags": ["Verification"],
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "202": {
            "description": "Proof request accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "proof_id": {
                      "type": "string",
                      "description": "Proof identifier (prf-{8 random chars})"
                    },
                    "status": {
                      "type": "string",
                      "enum": ["queued"],
                      "description": "Initial status"
                    },
                    "estimated_completion_ms": {
                      "type": "integer",
                      "description": "Estimated time to completion in milliseconds"
                    }
                  }
                }
              }
            }
          },
          "200": {
            "description": "Proof already exists for this checkpoint",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "proof_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Checkpoint not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to create proof request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/checkpoints/{checkpoint_id}/proof": {
      "get": {
        "operationId": "getProofStatus",
        "summary": "Get proof status",
        "description": "Get the ZK proof status and data for a checkpoint. Returns the most recent proof record including status, proof type, verification result, and timing metadata. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "checkpoint_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The checkpoint ID (ic-{uuid} format)"
          }
        ],
        "responses": {
          "200": {
            "description": "Proof status and data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProofStatusResponse"
                }
              }
            }
          },
          "404": {
            "description": "No proof found for this checkpoint",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/v1/agents/{agent_id}/merkle-root": {
      "get": {
        "operationId": "getAgentMerkleRoot",
        "summary": "Get Merkle root",
        "description": "Get the current Merkle tree root for an agent. The root is a SHA-256 hash that commits to the complete set of integrity checkpoints for this agent. Public endpoint, no authentication required.",
        "tags": ["Verification"],
        "security": [{}],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The agent ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Merkle tree root and metadata",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MerkleRootResponse"
                }
              }
            }
          },
          "404": {
            "description": "No Merkle tree found for this agent",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values": {
      "get": {
        "operationId": "listOrgConscienceValues",
        "summary": "List org conscience values",
        "description": "Returns all conscience values for the org, along with mode and enabled status. Requires Enterprise plan with custom_conscience_values feature flag.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Conscience values list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "mode": {"type": "string", "enum": ["augment", "replace"]},
                    "enabled": {"type": "boolean"},
                    "values": {"type": "array", "items": {"$ref": "#/components/schemas/OrgConscienceValue"}}
                  }
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      },
      "post": {
        "operationId": "createOrgConscienceValue",
        "summary": "Create org conscience value",
        "description": "Create a new custom conscience value. Max 20 per org. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name", "description", "type"],
                "properties": {
                  "name": {"type": "string", "minLength": 1, "maxLength": 50},
                  "description": {"type": "string", "minLength": 1, "maxLength": 500},
                  "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
                  "severity": {"type": "string", "enum": ["advisory", "mandatory"], "default": "advisory"}
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/OrgConscienceValue"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      }
    },
    "/orgs/{org_id}/conscience-values/{value_id}": {
      "patch": {
        "operationId": "updateOrgConscienceValue",
        "summary": "Update org conscience value",
        "description": "Update fields on an existing conscience value. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "value_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {"type": "string", "minLength": 1, "maxLength": 50},
                  "description": {"type": "string", "minLength": 1, "maxLength": 500},
                  "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
                  "severity": {"type": "string", "enum": ["advisory", "mandatory"]},
                  "is_active": {"type": "boolean"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/OrgConscienceValue"}
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "delete": {
        "operationId": "deleteOrgConscienceValue",
        "summary": "Delete org conscience value",
        "description": "Permanently delete a conscience value. Requires owner or admin role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}},
          {"name": "value_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"},
                    "id": {"type": "string"}
                  }
                }
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/orgs/{org_id}/conscience-values/order": {
      "put": {
        "operationId": "reorderOrgConscienceValues",
        "summary": "Reorder org conscience values",
        "description": "Set the sort order for all conscience values.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["order"],
                "properties": {
                  "order": {"type": "array", "items": {"type": "string"}}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reordered",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reordered": {"type": "boolean"},
                    "order": {"type": "array", "items": {"type": "string"}}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values/mode": {
      "put": {
        "operationId": "updateOrgConscienceMode",
        "summary": "Update org conscience mode",
        "description": "Set the conscience mode (augment/replace) and enabled flag.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "mode": {"type": "string", "enum": ["augment", "replace"]},
                  "enabled": {"type": "boolean"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "mode": {"type": "string", "enum": ["augment", "replace"]},
                    "enabled": {"type": "boolean"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/orgs/{org_id}/conscience-values/log": {
      "get": {
        "operationId": "getOrgConscienceAuditLog",
        "summary": "Get conscience values audit log",
        "description": "Returns the audit trail for conscience value changes. Requires owner, admin, or auditor role.",
        "tags": ["Conscience Values"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Audit log entries",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "org_id": {"type": "string"},
                    "entries": {"type": "array", "items": {"$ref": "#/components/schemas/OrgConscienceAuditEntry"}}
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/users/{userId}/impersonate": {
      "post": {
        "operationId": "startImpersonation",
        "summary": "Start impersonation session",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nCreates a session-based impersonation for viewing the dashboard as the target user. Returns an opaque token to include as X-Impersonate-Token header. Sessions expire after 1 hour.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Target user ID to impersonate"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {"type": "string", "description": "Optional reason for impersonation (audit trail)"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Impersonation session created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_id": {"type": "string"},
                    "token": {"type": "string", "description": "Opaque token for X-Impersonate-Token header"},
                    "target_user_id": {"type": "string"},
                    "target_email": {"type": "string"},
                    "expires_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "403": {"description": "Cannot impersonate admin users"},
          "404": {"description": "Target user not found"}
        }
      }
    },
    "/admin/impersonation/{sessionId}": {
      "get": {
        "operationId": "getImpersonationSession",
        "summary": "Get impersonation session status",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nReturns session details if active. Returns 410 Gone if expired or ended.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Impersonation session ID (ais-xxx)"
          }
        ],
        "responses": {
          "200": {
            "description": "Active session details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {"type": "string"},
                    "admin_user_id": {"type": "string"},
                    "target_user_id": {"type": "string"},
                    "target_email": {"type": "string"},
                    "reason": {"type": "string", "nullable": true},
                    "started_at": {"type": "string", "format": "date-time"},
                    "expires_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "404": {"description": "Session not found"},
          "410": {"description": "Session expired or ended"}
        }
      }
    },
    "/admin/impersonation/{sessionId}/end": {
      "post": {
        "operationId": "endImpersonation",
        "summary": "End impersonation session",
        "description": "**Requires ServiceRole authentication.** This endpoint is only accessible to platform administrators with the Supabase service role key. Regular API keys and user tokens cannot access this endpoint.\n\nMarks the impersonation session as ended. Audit-logged.",
        "tags": ["Admin"],
        "security": [{"ServiceRole": []}],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Impersonation session ID (ais-xxx)"
          }
        ],
        "responses": {
          "200": {
            "description": "Session ended",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ended": {"type": "boolean"},
                    "session_id": {"type": "string"}
                  }
                }
              }
            }
          },
          "403": {"description": "Not your impersonation session"},
          "404": {"description": "Session not found"}
        }
      }
    },
    "/orgs/{org_id}/card-template": {
      "get": {
        "operationId": "getOrgCardTemplate",
        "summary": "Get org card template",
        "description": "Returns the organization's alignment card template, including enabled status and the template card JSON. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Org card template",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgCardTemplate"
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "put": {
        "operationId": "updateOrgCardTemplate",
        "summary": "Update org card template",
        "description": "Create or update the organization's alignment card template. All agents in the org will inherit this template. Requires owner or admin role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["enabled", "template"],
                "properties": {
                  "enabled": {"type": "boolean", "description": "Whether the org card template is active"},
                  "template": {"$ref": "#/components/schemas/AlignmentCard", "description": "The alignment card template JSON"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Template updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrgCardTemplate"
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"}
        }
      },
      "delete": {
        "operationId": "deleteOrgCardTemplate",
        "summary": "Delete org card template",
        "description": "Delete the organization's alignment card template. All agents revert to using only their individual cards. Requires owner role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "org_id", "in": "path", "required": true, "schema": {"type": "string"}}
        ],
        "responses": {
          "200": {
            "description": "Template deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"}
                  }
                }
              }
            }
          },
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/org-card-exempt": {
      "put": {
        "operationId": "setAgentOrgCardExempt",
        "summary": "Set agent org card exemption",
        "description": "Set or remove an agent's exemption from the organization's card template. Exempt agents use only their individual card. Requires owner or admin role. Requires Enterprise plan.",
        "tags": ["Card Templates"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["exempt"],
                "properties": {
                  "exempt": {"type": "boolean", "description": "Whether the agent is exempt from the org card template"},
                  "reason": {"type": "string", "description": "Required when setting exempt=true. Stored in audit trail.", "maxLength": 500}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Exemption updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "exempt": {"type": "boolean"},
                    "reason": {"type": ["string", "null"]},
                    "updated_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams": {
      "post": {
        "operationId": "createTeam",
        "summary": "Create a team",
        "description": "Create a new team with at least 2 agent members. Team names must be unique within the organization.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["org_id", "name", "agent_ids"],
                "properties": {
                  "org_id": {"type": "string", "description": "Organization that owns this team"},
                  "name": {"type": "string", "maxLength": 100, "description": "Display name"},
                  "description": {"type": "string", "description": "Optional description"},
                  "agent_ids": {"type": "array", "items": {"type": "string"}, "minItems": 2, "maxItems": 50, "description": "Agent IDs to add as initial members"},
                  "metadata": {"type": "object", "additionalProperties": true, "description": "Freeform metadata"}
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Team created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "team": {"$ref": "#/components/schemas/Team"},
                    "members": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/TeamMember"}
                    }
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "409": {
            "description": "Team name already taken within the organization",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          }
        }
      }
    },
    "/teams/{team_id}": {
      "get": {
        "operationId": "getTeam",
        "summary": "Get team by ID",
        "description": "Retrieve a team and its current members.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Team details with members",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "team": {"$ref": "#/components/schemas/Team"},
                    "members": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/TeamMember"}
                    }
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "patch": {
        "operationId": "updateTeam",
        "summary": "Update team",
        "description": "Update a team's name, description, or metadata.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {"type": "string", "maxLength": 100, "description": "Display name"},
                  "description": {"type": ["string", "null"], "description": "Optional description"},
                  "metadata": {"type": "object", "additionalProperties": true, "description": "Freeform metadata"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated team",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Team"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"},
          "409": {
            "description": "Team name already taken within the organization",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          }
        }
      },
      "delete": {
        "operationId": "archiveTeam",
        "summary": "Archive team",
        "description": "Archive a team. Archived teams are soft-deleted and can be listed with status=archived.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Team archived",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "archived": {"type": "boolean"},
                    "team_id": {"type": "string"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/members": {
      "post": {
        "operationId": "addTeamMembers",
        "summary": "Add members to team",
        "description": "Add one or more agents to a team. Teams have a maximum of 50 members.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["agent_ids"],
                "properties": {
                  "agent_ids": {"type": "array", "items": {"type": "string"}, "minItems": 1, "description": "Agent IDs to add"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Members added",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "added": {"type": "array", "items": {"type": "string"}},
                    "already_members": {"type": "array", "items": {"type": "string"}},
                    "members": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/TeamMember"}
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Exceeds 50-member maximum",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/members/{agent_id}": {
      "delete": {
        "operationId": "removeTeamMember",
        "summary": "Remove member from team",
        "description": "Remove an agent from a team. Teams must retain a minimum of 2 members.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"},
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "responses": {
          "200": {
            "description": "Member removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "removed": {"type": "boolean"},
                    "agent_id": {"type": "string"}
                  }
                }
              }
            }
          },
          "400": {
            "description": "Cannot remove member: team requires minimum 2 members",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/roster-history": {
      "get": {
        "operationId": "getTeamRosterHistory",
        "summary": "Get team roster history",
        "description": "Retrieve the history of member additions and removals for a team.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"},
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}, "description": "Page number"},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 50, "maximum": 200}, "description": "Results per page (max 200)"}
        ],
        "responses": {
          "200": {
            "description": "Roster change history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "changes": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/TeamRosterChange"}
                    },
                    "total": {"type": "integer"},
                    "page": {"type": "integer"},
                    "per_page": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/orgs/{org_id}/teams": {
      "get": {
        "operationId": "listOrgTeams",
        "summary": "List teams in organization",
        "description": "List all teams belonging to an organization, filtered by status.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/OrgId"},
          {"name": "status", "in": "query", "schema": {"type": "string", "enum": ["active", "archived"], "default": "active"}, "description": "Filter by team status"},
          {"name": "page", "in": "query", "schema": {"type": "integer", "default": 1}, "description": "Page number"},
          {"name": "per_page", "in": "query", "schema": {"type": "integer", "default": 50, "maximum": 200}, "description": "Results per page (max 200)"}
        ],
        "responses": {
          "200": {
            "description": "Paginated list of teams",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "teams": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/Team"}
                    },
                    "total": {"type": "integer"},
                    "page": {"type": "integer"},
                    "per_page": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/card": {
      "get": {
        "operationId": "getTeamCard",
        "summary": "Get team alignment card",
        "description": "Retrieve the active alignment card for a team, or null if no card is set.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Team alignment card or null",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "card_id": {"type": "string"},
                    "team_id": {"type": "string"},
                    "card_json": {"type": "object"},
                    "card_source": {"type": "string", "enum": ["manual", "auto_derived", "hybrid"]},
                    "issued_at": {"type": "string", "format": "date-time"},
                    "is_active": {"type": "boolean"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "put": {
        "operationId": "setTeamCard",
        "summary": "Set team alignment card",
        "description": "Manually set an alignment card for a team. The card must include principal, values, autonomy_envelope, and audit_commitment sections.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["principal", "values", "autonomy_envelope", "audit_commitment"],
                "properties": {
                  "principal": {"type": "object", "description": "Principal section of the alignment card"},
                  "values": {
                    "type": "object",
                    "required": ["declared"],
                    "properties": {
                      "declared": {"type": "array", "items": {"type": "object"}}
                    },
                    "description": "Values section with declared values array"
                  },
                  "autonomy_envelope": {"type": "object", "description": "Autonomy envelope section"},
                  "audit_commitment": {"type": "object", "description": "Audit commitment section"}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Card set",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "card_id": {"type": "string"},
                    "team_id": {"type": "string"},
                    "card_source": {"type": "string", "enum": ["manual"]},
                    "issued_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid alignment card",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/card/derive": {
      "post": {
        "operationId": "deriveTeamCard",
        "summary": "Derive team alignment card from members",
        "description": "Automatically derive a team alignment card from the individual cards of team members. Requires at least 2 members with active alignment cards.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Derived card",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "derived_card": {"type": "object"},
                    "card_source": {"type": "string", "enum": ["auto_derived"]},
                    "member_count": {"type": "integer"},
                    "members_with_cards": {"type": "integer"}
                  }
                }
              }
            }
          },
          "400": {
            "description": "Requires at least 2 members with alignment cards",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "403": {"$ref": "#/components/responses/Forbidden"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/card/history": {
      "get": {
        "operationId": "getTeamCardHistory",
        "summary": "Get team card history",
        "description": "Retrieve the history of alignment cards for a team.",
        "tags": ["Teams"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Card history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "cards": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "card_id": {"type": "string"},
                          "card_source": {"type": "string", "enum": ["manual", "auto_derived", "hybrid"]},
                          "issued_at": {"type": "string", "format": "date-time"},
                          "is_active": {"type": "boolean"}
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/reputation": {
      "get": {
        "operationId": "getTeamReputation",
        "summary": "Get team reputation score",
        "description": "Retrieve the current reputation score for a team, including component breakdown and A2A trust extension.",
        "tags": ["Team Reputation"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Team reputation score",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/TeamReputationScore"}
              }
            }
          },
          "403": {
            "description": "Team reputation is private",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/reputation/history": {
      "get": {
        "operationId": "getTeamReputationHistory",
        "summary": "Get team reputation history",
        "description": "Retrieve weekly reputation score snapshots for a team.",
        "tags": ["Team Reputation"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Reputation history snapshots",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "snapshots": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/TeamReputationSnapshot"}
                    }
                  }
                }
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/reputation/verify": {
      "get": {
        "operationId": "verifyTeamReputation",
        "summary": "Verify team reputation cryptographically",
        "description": "Public endpoint. Returns the team's reputation score with a cryptographic proof hash for independent verification.",
        "tags": ["Team Reputation"],
        "security": [],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"}
        ],
        "responses": {
          "200": {
            "description": "Reputation with verification proof",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "team_id": {"type": "string"},
                    "score": {"type": "number"},
                    "grade": {"type": "string"},
                    "computed_at": {"type": "string", "format": "date-time"},
                    "verification": {
                      "type": ["object", "null"],
                      "properties": {
                        "proof_hash": {"type": "string"},
                        "computed_at": {"type": "string", "format": "date-time"},
                        "total_assessments": {"type": "integer"}
                      }
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Team reputation is private",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Error"}
              }
            }
          },
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/teams/{team_id}/badge.svg": {
      "get": {
        "operationId": "getTeamBadge",
        "summary": "Get embeddable team reputation badge",
        "description": "Public endpoint. Returns an SVG badge displaying the team's reputation score or grade. Returns a 'Not Rated' badge for unknown teams.",
        "tags": ["Team Reputation"],
        "security": [],
        "parameters": [
          {"$ref": "#/components/parameters/TeamId"},
          {"name": "variant", "in": "query", "schema": {"type": "string", "enum": ["score", "grade", "score_grade", "score_trend", "score_tier", "compact"], "default": "grade"}, "description": "Badge variant"},
          {"name": "style", "in": "query", "schema": {"type": "string", "enum": ["light", "dark"], "default": "light"}, "description": "Badge color scheme"}
        ],
        "responses": {
          "200": {
            "description": "SVG badge image",
            "headers": {
              "Cache-Control": {
                "schema": {"type": "string"},
                "description": "public, max-age=3600"
              }
            },
            "content": {
              "image/svg+xml": {
                "schema": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },

    "/agents/{agent_id}/policy": {
      "get": {
        "operationId": "getAgentPolicy",
        "summary": "Get agent policy",
        "description": "Retrieve the CLPI policy currently assigned to the specified agent. Returns the full policy document including capability mappings, forbidden rules, escalation triggers, and enforcement defaults.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "responses": {
          "200": {
            "description": "Agent policy document",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Policy"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "put": {
        "operationId": "setAgentPolicy",
        "summary": "Set agent policy",
        "description": "Create or replace the CLPI policy for the specified agent. The policy defines which tools map to which capabilities, forbidden tool patterns, escalation triggers, and enforcement defaults. Agent-level policies override org-level policies when merged.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {"$ref": "#/components/schemas/Policy"}
            }
          }
        },
        "responses": {
          "200": {
            "description": "Policy saved successfully",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Policy"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "delete": {
        "operationId": "deleteAgentPolicy",
        "summary": "Delete agent policy",
        "description": "Remove the agent-level CLPI policy. After deletion the agent will inherit the org-level policy (if any) or operate with no policy constraints.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "responses": {
          "200": {
            "description": "Policy deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/policy/resolved": {
      "get": {
        "operationId": "getAgentPolicyResolved",
        "summary": "Get merged org+agent policy",
        "description": "Returns the effective policy for the agent after merging the org-level policy with any agent-level overrides. This is the policy that the enforcement engine actually applies at runtime. Org defaults are used for any field not overridden at the agent level.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "responses": {
          "200": {
            "description": "Merged effective policy",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Policy"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/orgs/{org_id}/policy": {
      "get": {
        "operationId": "getOrgPolicy",
        "summary": "Get org policy",
        "description": "Retrieve the CLPI policy defined at the organization level. All agents in the org inherit this policy unless they have agent-level overrides.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/OrgId"}
        ],
        "responses": {
          "200": {
            "description": "Organization policy document",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Policy"}
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "put": {
        "operationId": "setOrgPolicy",
        "summary": "Set org policy",
        "description": "Create or replace the CLPI policy at the organization level. This policy applies to all agents in the org as the base layer, which agent-level policies can override.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/OrgId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {"$ref": "#/components/schemas/Policy"}
            }
          }
        },
        "responses": {
          "200": {
            "description": "Organization policy saved",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/Policy"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "delete": {
        "operationId": "deleteOrgPolicy",
        "summary": "Delete org policy",
        "description": "Remove the organization-level CLPI policy. All agents in the org will lose their inherited policy defaults and rely solely on agent-level policies (if any).",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/OrgId"}
        ],
        "responses": {
          "200": {
            "description": "Organization policy deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/orgs/{org_id}/policy/history": {
      "get": {
        "operationId": "getOrgPolicyHistory",
        "summary": "Get org policy version history",
        "description": "Retrieve the version history of the organization's CLPI policy. Each entry includes the full policy snapshot, who made the change, and when. Useful for auditing policy evolution over time.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/OrgId"},
          {"name": "limit", "in": "query", "schema": {"type": "integer", "default": 20, "minimum": 1, "maximum": 100}, "description": "Maximum number of versions to return"},
          {"name": "offset", "in": "query", "schema": {"type": "integer", "default": 0, "minimum": 0}, "description": "Number of versions to skip for pagination"}
        ],
        "responses": {
          "200": {
            "description": "Policy version history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "versions": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "version": {"type": "integer"},
                          "policy": {"$ref": "#/components/schemas/Policy"},
                          "changed_by": {"type": "string"},
                          "changed_at": {"type": "string", "format": "date-time"},
                          "change_summary": {"type": "string"}
                        }
                      }
                    },
                    "total": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/policies/evaluate": {
      "post": {
        "operationId": "evaluatePolicy",
        "summary": "Evaluate policy against tools",
        "description": "Evaluate a CLPI policy against a list of tools to determine which are allowed, forbidden, or unmapped. Returns a verdict with detailed violations, warnings, card coverage gaps, and overall coverage percentage. Useful for dry-run validation before deploying a policy.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["policy", "tools"],
                "properties": {
                  "policy": {"$ref": "#/components/schemas/Policy"},
                  "tools": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "List of tool identifiers to evaluate against the policy"
                  },
                  "agent_id": {
                    "type": "string",
                    "description": "Optional agent ID to include agent-specific context in evaluation"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Policy evaluation result",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/PolicyEvaluationResult"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/policies/evaluate/historical": {
      "post": {
        "operationId": "evaluatePolicyHistorical",
        "summary": "Evaluate policy against historical traces",
        "description": "Evaluate a CLPI policy against historical AIP traces for an agent. Replays past tool invocations through the policy to identify what would have been blocked, escalated, or flagged. Useful for understanding the impact of a policy change before rolling it out.",
        "tags": ["Policy"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["policy", "agent_id"],
                "properties": {
                  "policy": {"$ref": "#/components/schemas/Policy"},
                  "agent_id": {
                    "type": "string",
                    "description": "Agent whose historical traces will be evaluated"
                  },
                  "from": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Start of time range for historical traces"
                  },
                  "to": {
                    "type": "string",
                    "format": "date-time",
                    "description": "End of time range for historical traces"
                  },
                  "limit": {
                    "type": "integer",
                    "default": 100,
                    "description": "Maximum number of traces to evaluate"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Historical evaluation result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "evaluation": {"$ref": "#/components/schemas/PolicyEvaluationResult"},
                    "traces_evaluated": {"type": "integer"},
                    "time_range": {
                      "type": "object",
                      "properties": {
                        "from": {"type": "string", "format": "date-time"},
                        "to": {"type": "string", "format": "date-time"}
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },

    "/agents/{agent_id}/reclassify": {
      "post": {
        "operationId": "reclassifyViolation",
        "summary": "Reclassify a checkpoint violation",
        "description": "Reclassify a previously recorded AIP checkpoint violation. This allows operators to correct false positives or adjust severity after manual review. The reclassification is recorded in the audit trail and can trigger a score recomputation.",
        "tags": ["Reclassification"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {"$ref": "#/components/schemas/ReclassificationRequest"}
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reclassification result with score impact",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/ReclassificationResult"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/reputation/{agent_id}/recompute": {
      "post": {
        "operationId": "recomputeReputationScore",
        "summary": "Trigger score recomputation",
        "description": "Trigger a full recomputation of the agent's reputation and compliance scores. This re-evaluates all checkpoints, reclassifications, and card amendments to produce an updated score. Useful after bulk reclassifications or policy changes.",
        "tags": ["Reclassification"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "agent_id",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Agent identifier"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {
                    "type": "string",
                    "description": "Reason for triggering recomputation"
                  },
                  "include_reclassifications": {
                    "type": "boolean",
                    "default": true,
                    "description": "Whether to include pending reclassifications in the recomputation"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Recomputation result with new scores",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "previous_score": {"type": "number"},
                    "new_score": {"type": "number"},
                    "delta": {"type": "number"},
                    "reclassifications_applied": {"type": "integer"},
                    "recomputed_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/compliance-export": {
      "get": {
        "operationId": "exportComplianceRecord",
        "summary": "Export compliance record",
        "description": "Export a comprehensive compliance record for the agent including all checkpoints, reclassifications, card amendments, and score history. Returns a structured document suitable for regulatory audits and compliance reviews.",
        "tags": ["Reclassification"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"},
          {"name": "format", "in": "query", "schema": {"type": "string", "enum": ["json", "csv"], "default": "json"}, "description": "Export format"},
          {"name": "from", "in": "query", "schema": {"type": "string", "format": "date-time"}, "description": "Start of time range"},
          {"name": "to", "in": "query", "schema": {"type": "string", "format": "date-time"}, "description": "End of time range"}
        ],
        "responses": {
          "200": {
            "description": "Compliance export data",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "export_id": {"type": "string"},
                    "generated_at": {"type": "string", "format": "date-time"},
                    "period": {
                      "type": "object",
                      "properties": {
                        "from": {"type": "string", "format": "date-time"},
                        "to": {"type": "string", "format": "date-time"}
                      }
                    },
                    "checkpoints": {"type": "array", "items": {"type": "object"}},
                    "reclassifications": {"type": "array", "items": {"$ref": "#/components/schemas/ReclassificationResult"}},
                    "card_amendments": {"type": "array", "items": {"type": "object"}},
                    "score_history": {"type": "array", "items": {"type": "object"}}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/reclassifications": {
      "get": {
        "operationId": "listReclassifications",
        "summary": "List reclassification history",
        "description": "Retrieve the history of all checkpoint reclassifications for the specified agent. Each entry includes the original and reclassified type, reason, and score impact.",
        "tags": ["Reclassification"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"},
          {"name": "limit", "in": "query", "schema": {"type": "integer", "default": 20, "minimum": 1, "maximum": 100}, "description": "Maximum number of records to return"},
          {"name": "offset", "in": "query", "schema": {"type": "integer", "default": 0, "minimum": 0}, "description": "Number of records to skip for pagination"}
        ],
        "responses": {
          "200": {
            "description": "Reclassification history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reclassifications": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/ReclassificationResult"}
                    },
                    "total": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/agents/{agent_id}/card-amendments": {
      "get": {
        "operationId": "listCardAmendments",
        "summary": "List card amendment history",
        "description": "Retrieve the history of all alignment card amendments for the specified agent. Card amendments are changes to the agent's alignment card that were triggered by reclassifications, policy changes, or manual edits.",
        "tags": ["Reclassification"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"},
          {"name": "limit", "in": "query", "schema": {"type": "integer", "default": 20, "minimum": 1, "maximum": 100}, "description": "Maximum number of amendments to return"},
          {"name": "offset", "in": "query", "schema": {"type": "integer", "default": 0, "minimum": 0}, "description": "Number of amendments to skip for pagination"}
        ],
        "responses": {
          "200": {
            "description": "Card amendment history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "amendments": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "amendment_id": {"type": "string"},
                          "agent_id": {"type": "string"},
                          "field_changed": {"type": "string"},
                          "old_value": {},
                          "new_value": {},
                          "reason": {"type": "string"},
                          "triggered_by": {"type": "string", "enum": ["reclassification", "policy_change", "manual"]},
                          "created_at": {"type": "string", "format": "date-time"}
                        }
                      }
                    },
                    "total": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },

    "/teams/fault-lines": {
      "post": {
        "operationId": "analyzeTeamFaultLines",
        "summary": "Analyze team fault lines",
        "description": "Analyze alignment fault lines across a team of agents. Identifies capabilities, values, or constraints that some agents declare but others miss, creating potential alignment gaps. Returns a fleet-wide score with individual fault line details and resolution hints.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["team_id"],
                "properties": {
                  "team_id": {
                    "type": "string",
                    "description": "Team identifier to analyze"
                  },
                  "agent_ids": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Optional subset of agent IDs to analyze. If omitted, all team members are analyzed."
                  },
                  "dimensions": {
                    "type": "array",
                    "items": {"type": "string", "enum": ["capabilities", "values", "constraints", "tools", "policies"]},
                    "description": "Dimensions to analyze for fault lines"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Fault line analysis result",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/FaultLineAnalysis"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/teams/forecast": {
      "post": {
        "operationId": "forecastTeamRisks",
        "summary": "Forecast team risks",
        "description": "Forecast potential risks and failure modes for a team based on current alignment state, historical trends, and known fault lines. Returns ranked failure modes with probability estimates, impact assessments, and mitigation suggestions.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["team_id"],
                "properties": {
                  "team_id": {
                    "type": "string",
                    "description": "Team identifier to forecast"
                  },
                  "horizon_days": {
                    "type": "integer",
                    "default": 30,
                    "description": "Forecast horizon in days"
                  },
                  "include_mitigations": {
                    "type": "boolean",
                    "default": true,
                    "description": "Whether to include mitigation suggestions"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Risk forecast result",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/RiskForecast"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/teams/recommend-policy": {
      "post": {
        "operationId": "recommendTeamPolicy",
        "summary": "Generate policy recommendation",
        "description": "Generate a recommended CLPI policy for a team based on current agent capabilities, alignment cards, historical violations, and known fault lines. The recommendation aims to close coverage gaps while minimizing disruption to existing workflows.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["team_id"],
                "properties": {
                  "team_id": {
                    "type": "string",
                    "description": "Team identifier to generate recommendation for"
                  },
                  "strictness": {
                    "type": "string",
                    "enum": ["permissive", "balanced", "strict"],
                    "default": "balanced",
                    "description": "Desired strictness level for the recommended policy"
                  },
                  "existing_policy": {
                    "$ref": "#/components/schemas/Policy",
                    "description": "Optional existing policy to use as a starting point"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Policy recommendation",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "recommended_policy": {"$ref": "#/components/schemas/Policy"},
                    "rationale": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "field": {"type": "string"},
                          "reason": {"type": "string"},
                          "confidence": {"type": "number", "minimum": 0, "maximum": 1}
                        }
                      }
                    },
                    "expected_coverage": {"type": "number", "minimum": 0, "maximum": 1},
                    "fault_lines_addressed": {"type": "integer"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/transactions": {
      "post": {
        "operationId": "createTransaction",
        "summary": "Create transaction with guardrails",
        "description": "Create a new guarded transaction. The transaction wraps one or more agent actions with CLPI policy guardrails, ensuring all tool invocations are evaluated against the effective policy before execution. Returns the transaction ID and initial evaluation status.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["agent_id", "actions"],
                "properties": {
                  "agent_id": {
                    "type": "string",
                    "description": "Agent performing the transaction"
                  },
                  "actions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "tool": {"type": "string", "description": "Tool identifier"},
                        "parameters": {"type": "object", "description": "Tool parameters"},
                        "justification": {"type": "string", "description": "Why this action is needed"}
                      }
                    },
                    "description": "List of actions to execute within the transaction"
                  },
                  "policy_override": {
                    "$ref": "#/components/schemas/Policy",
                    "description": "Optional policy to use instead of the agent's effective policy"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Transaction created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {"type": "string"},
                    "agent_id": {"type": "string"},
                    "status": {"type": "string", "enum": ["pending", "approved", "blocked", "escalated"]},
                    "evaluation": {"$ref": "#/components/schemas/PolicyEvaluationResult"},
                    "created_at": {"type": "string", "format": "date-time"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/transactions/{id}": {
      "get": {
        "operationId": "getTransaction",
        "summary": "Get transaction details",
        "description": "Retrieve the details of a guarded transaction including its current status, policy evaluation result, and action outcomes.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Transaction identifier"
          }
        ],
        "responses": {
          "200": {
            "description": "Transaction details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {"type": "string"},
                    "agent_id": {"type": "string"},
                    "status": {"type": "string", "enum": ["pending", "approved", "blocked", "escalated", "completed", "failed"]},
                    "actions": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "tool": {"type": "string"},
                          "status": {"type": "string"},
                          "result": {}
                        }
                      }
                    },
                    "evaluation": {"$ref": "#/components/schemas/PolicyEvaluationResult"},
                    "created_at": {"type": "string", "format": "date-time"},
                    "completed_at": {"type": ["string", "null"], "format": "date-time"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      },
      "delete": {
        "operationId": "deleteTransaction",
        "summary": "Delete transaction",
        "description": "Delete a guarded transaction. Only transactions in pending or completed status can be deleted. Active transactions must be completed or cancelled first.",
        "tags": ["Intelligence"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {"type": "string"},
            "description": "Transaction identifier"
          }
        ],
        "responses": {
          "200": {
            "description": "Transaction deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "deleted": {"type": "boolean"},
                    "id": {"type": "string"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },

    "/on-chain/anchor-root": {
      "post": {
        "operationId": "anchorMerkleRoot",
        "summary": "Anchor Merkle root on-chain",
        "description": "Anchor a Merkle root hash on-chain for a batch of integrity proofs. This creates an immutable, publicly verifiable record of the integrity state at a point in time. Returns the transaction hash, block number, and gas used.",
        "tags": ["On-Chain"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["merkle_root", "agent_ids"],
                "properties": {
                  "merkle_root": {
                    "type": "string",
                    "description": "Hex-encoded Merkle root hash to anchor"
                  },
                  "agent_ids": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "Agent IDs included in this Merkle tree"
                  },
                  "metadata": {
                    "type": "object",
                    "properties": {
                      "batch_size": {"type": "integer"},
                      "tree_depth": {"type": "integer"},
                      "algorithm": {"type": "string", "default": "keccak256"}
                    },
                    "description": "Optional metadata about the Merkle tree"
                  },
                  "chain": {
                    "type": "string",
                    "enum": ["ethereum", "polygon", "base"],
                    "default": "base",
                    "description": "Target blockchain network"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Anchor result with transaction details",
            "content": {
              "application/json": {
                "schema": {"$ref": "#/components/schemas/OnChainAnchorResult"}
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/on-chain/publish-scores": {
      "post": {
        "operationId": "publishScoresOnChain",
        "summary": "Publish scores on-chain",
        "description": "Publish agent integrity or reputation scores on-chain for public verifiability. Scores are batched into a Merkle tree and the root is anchored. Individual scores can later be verified using Merkle proofs.",
        "tags": ["On-Chain"],
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["scores"],
                "properties": {
                  "scores": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["agent_id", "score", "score_type"],
                      "properties": {
                        "agent_id": {"type": "string"},
                        "score": {"type": "number"},
                        "score_type": {"type": "string", "enum": ["integrity", "reputation", "compliance"]},
                        "timestamp": {"type": "string", "format": "date-time"}
                      }
                    },
                    "description": "Scores to publish on-chain"
                  },
                  "chain": {
                    "type": "string",
                    "enum": ["ethereum", "polygon", "base"],
                    "default": "base",
                    "description": "Target blockchain network"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Score publishing result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "anchor": {"$ref": "#/components/schemas/OnChainAnchorResult"},
                    "scores_published": {"type": "integer"},
                    "proofs": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "agent_id": {"type": "string"},
                          "proof": {
                            "type": "array",
                            "items": {"type": "string"},
                            "description": "Merkle proof hashes"
                          },
                          "leaf_index": {"type": "integer"}
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    },
    "/on-chain/verify-proof/{agent_id}": {
      "get": {
        "operationId": "verifyOnChainProof",
        "summary": "Verify on-chain proof",
        "description": "Verify an agent's integrity or score proof against the on-chain Merkle root. Checks that the provided proof correctly links the agent's data to an anchored root, confirming the data has not been tampered with since anchoring.",
        "tags": ["On-Chain"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"},
          {"name": "anchor_id", "in": "query", "schema": {"type": "string"}, "description": "Specific anchor ID to verify against. If omitted, verifies against the most recent anchor."},
          {"name": "score_type", "in": "query", "schema": {"type": "string", "enum": ["integrity", "reputation", "compliance"]}, "description": "Type of score proof to verify"}
        ],
        "responses": {
          "200": {
            "description": "Proof verification result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "valid": {"type": "boolean"},
                    "agent_id": {"type": "string"},
                    "anchor_id": {"type": "string"},
                    "merkle_root": {"type": "string"},
                    "proof": {
                      "type": "array",
                      "items": {"type": "string"}
                    },
                    "score": {"type": "number"},
                    "score_type": {"type": "string"},
                    "anchored_at": {"type": "string", "format": "date-time"},
                    "tx_hash": {"type": "string"},
                    "chain": {"type": "string"}
                  }
                }
              }
            }
          },
          "400": {"$ref": "#/components/responses/BadRequest"},
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/on-chain/status/{agent_id}": {
      "get": {
        "operationId": "getOnChainStatus",
        "summary": "Get on-chain status",
        "description": "Get the current on-chain anchoring status for an agent. Returns the most recent anchor, pending publications, and overall on-chain coverage statistics.",
        "tags": ["On-Chain"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"$ref": "#/components/parameters/AgentId"}
        ],
        "responses": {
          "200": {
            "description": "On-chain status for the agent",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "agent_id": {"type": "string"},
                    "latest_anchor": {"$ref": "#/components/schemas/OnChainAnchorResult"},
                    "total_anchors": {"type": "integer"},
                    "pending_publications": {"type": "integer"},
                    "coverage": {
                      "type": "object",
                      "properties": {
                        "integrity_anchored": {"type": "boolean"},
                        "reputation_anchored": {"type": "boolean"},
                        "last_anchored_at": {"type": "string", "format": "date-time"}
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"},
          "404": {"$ref": "#/components/responses/NotFound"}
        }
      }
    },
    "/on-chain/history": {
      "get": {
        "operationId": "getOnChainHistory",
        "summary": "Get on-chain history",
        "description": "Retrieve the history of on-chain Merkle root anchoring events. Returns a paginated list of all anchors with their transaction details, included agents, and verification status.",
        "tags": ["On-Chain"],
        "security": [{"BearerAuth": []}],
        "parameters": [
          {"name": "chain", "in": "query", "schema": {"type": "string", "enum": ["ethereum", "polygon", "base"]}, "description": "Filter by blockchain network"},
          {"name": "agent_id", "in": "query", "schema": {"type": "string"}, "description": "Filter anchors that include this agent"},
          {"name": "from", "in": "query", "schema": {"type": "string", "format": "date-time"}, "description": "Start of time range"},
          {"name": "to", "in": "query", "schema": {"type": "string", "format": "date-time"}, "description": "End of time range"},
          {"name": "limit", "in": "query", "schema": {"type": "integer", "default": 20, "minimum": 1, "maximum": 100}, "description": "Maximum number of records to return"},
          {"name": "offset", "in": "query", "schema": {"type": "integer", "default": 0, "minimum": 0}, "description": "Number of records to skip for pagination"}
        ],
        "responses": {
          "200": {
            "description": "On-chain anchoring history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "anchors": {
                      "type": "array",
                      "items": {"$ref": "#/components/schemas/OnChainAnchorResult"}
                    },
                    "total": {"type": "integer"}
                  }
                }
              }
            }
          },
          "401": {"$ref": "#/components/responses/Unauthorized"}
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase JWT token in Authorization: Bearer header"
      },
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-Mnemom-Api-Key",
        "description": "Mnemom API key (mnm_... format)"
      },
      "ServiceRole": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase service role key for admin and service endpoints"
      }
    },
    "parameters": {
      "AgentId": {
        "name": "agent_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Agent identifier (e.g. smolt-abc123)"
      },
      "OrgId": {
        "name": "org_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Organization identifier (e.g. org-abc12345)"
      },
      "EndpointId": {
        "name": "endpoint_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Webhook endpoint identifier (e.g. whe-abc12345)"
      },
      "TeamId": {
        "name": "team_id",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string"
        },
        "description": "Team identifier (UUID)"
      }
    },
    "responses": {
      "BadRequest": {
        "description": "Bad request",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "Unauthorized": {
        "description": "Authentication required",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "Forbidden": {
        "description": "Forbidden",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "NotFound": {
        "description": "Resource not found",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "required": [
          "error"
        ],
        "properties": {
          "error": {
            "type": "string"
          }
        }
      },
      "Agent": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "agent_hash": {
            "type": "string"
          },
          "user_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "email": {
            "type": [
              "string",
              "null"
            ]
          },
          "claimed_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "last_seen": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "offline"
            ]
          },
          "public": {
            "type": "boolean"
          },
          "aip_enforcement_mode": {
            "type": [
              "string",
              "null"
            ],
            "enum": [
              "observe",
              "enforce",
              "nudge"
            ]
          },
          "billing_account_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "AlignmentCard": {
        "type": "object",
        "properties": {
          "card_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "is_active": {
            "type": "boolean"
          },
          "card_json": {
            "type": "object",
            "description": "Full alignment card JSON per AAP spec"
          },
          "conscience_values": {
            "type": [
              "array",
              "null"
            ],
            "items": {
              "$ref": "#/components/schemas/ConscienceValue"
            }
          },
          "issued_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "APTrace": {
        "type": "object",
        "properties": {
          "trace_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "action": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "category": {
                "type": "string"
              }
            }
          },
          "decision": {
            "type": "object",
            "properties": {
              "selected": {
                "type": "string"
              },
              "selection_reasoning": {
                "type": "string"
              },
              "values_applied": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "confidence": {
                "type": [
                  "number",
                  "null"
                ]
              }
            }
          },
          "verification": {
            "type": [
              "object",
              "null"
            ],
            "properties": {
              "verified": {
                "type": "boolean"
              },
              "violations": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "IntegrityScore": {
        "type": "object",
        "properties": {
          "agent_id": {
            "type": "string"
          },
          "total_traces": {
            "type": "integer"
          },
          "verified_traces": {
            "type": "integer"
          },
          "violation_count": {
            "type": "integer"
          },
          "integrity_score": {
            "type": "number",
            "description": "Value between 0 and 1"
          }
        }
      },
      "Checkpoint": {
        "type": "object",
        "properties": {
          "checkpoint_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "card_id": {
            "type": "string"
          },
          "session_id": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "thinking_block_hash": {
            "type": "string"
          },
          "provider": {
            "type": "string"
          },
          "model": {
            "type": "string"
          },
          "verdict": {
            "type": "string",
            "enum": [
              "clear",
              "review_needed",
              "boundary_violation"
            ]
          },
          "concerns": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "category": {
                  "type": "string"
                },
                "severity": {
                  "type": "string"
                },
                "description": {
                  "type": "string"
                },
                "evidence": {
                  "type": "string"
                }
              }
            }
          },
          "reasoning_summary": {
            "type": "string"
          },
          "conscience_context": {
            "type": "object"
          },
          "window_position": {
            "type": "object",
            "properties": {
              "index": {
                "type": "integer"
              },
              "window_size": {
                "type": "integer"
              }
            }
          },
          "analysis_metadata": {
            "type": "object"
          },
          "linked_trace_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "re_evaluated_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "original_verdict": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "DriftAlert": {
        "type": "object",
        "properties": {
          "alert_id": {
            "type": "string"
          },
          "agent_id": {
            "type": "string"
          },
          "session_id": {
            "type": "string"
          },
          "checkpoint_ids": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "sustained_checks": {
            "type": "integer"
          },
          "severity": {
            "type": "string",
            "enum": [
              "low",
              "medium",
              "high"
            ]
          },
          "drift_direction": {
            "type": "string"
          },
          "message": {
            "type": "string"
          },
          "detection_timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ConscienceValue": {
        "type": "object",
        "required": [
          "type",
          "name",
          "content"
        ],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "BOUNDARY",
              "FEAR",
              "COMMITMENT",
              "BELIEF",
              "HOPE"
            ]
          },
          "name": {
            "type": "string"
          },
          "content": {
            "type": "string"
          }
        }
      },
      "EnforcementMode": {
        "type": "object",
        "properties": {
          "agent_id": {
            "type": "string"
          },
          "enforcement_mode": {
            "type": "string",
            "enum": [
              "observe",
              "enforce",
              "nudge"
            ],
            "default": "observe"
          }
        }
      },
      "Subscription": {
        "type": "object",
        "properties": {
          "subscription": {
            "type": [
              "object",
              "null"
            ]
          },
          "plan_id": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "check_count_this_period": {
            "type": "integer"
          }
        }
      },
      "Invoice": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "amount_due": {
            "type": "integer"
          },
          "amount_paid": {
            "type": "integer"
          },
          "currency": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "created": {
            "type": "integer"
          },
          "hosted_invoice_url": {
            "type": [
              "string",
              "null"
            ]
          },
          "invoice_pdf": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "UsageMetrics": {
        "type": "object",
        "properties": {
          "daily": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "rollup_date": {
                  "type": "string",
                  "format": "date"
                },
                "check_count": {
                  "type": "integer"
                },
                "tokens_in": {
                  "type": "integer"
                },
                "tokens_out": {
                  "type": "integer"
                }
              }
            }
          },
          "summary": {
            "type": "object",
            "properties": {
              "checks_used": {
                "type": "integer"
              },
              "checks_included": {
                "type": "integer"
              },
              "overage": {
                "type": "integer"
              },
              "estimated_overage_cost": {
                "type": "number"
              },
              "period_start": {
                "type": "string",
                "format": "date-time"
              },
              "period_end": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      },
      "Plan": {
        "type": "object",
        "properties": {
          "plan_id": {
            "type": "string"
          },
          "display_name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "billing_model": {
            "type": "string",
            "enum": [
              "none",
              "metered",
              "subscription",
              "subscription_plus_metered"
            ]
          },
          "base_price_cents": {
            "type": "integer"
          },
          "annual_price_cents": {
            "type": "integer"
          },
          "per_check_price": {
            "type": "number"
          },
          "included_checks": {
            "type": "integer"
          },
          "trace_retention_days": {
            "type": "integer"
          },
          "feature_flags": {
            "type": "object",
            "additionalProperties": {
              "type": "boolean"
            }
          },
          "limits": {
            "type": "object"
          },
          "sort_order": {
            "type": "integer"
          }
        }
      },
      "Organization": {
        "type": "object",
        "properties": {
          "org_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "slug": {
            "type": "string"
          },
          "billing_account_id": {
            "type": "string"
          },
          "owner_user_id": {
            "type": "string"
          },
          "billing_email": {
            "type": [
              "string",
              "null"
            ]
          },
          "company_name": {
            "type": [
              "string",
              "null"
            ]
          },
          "member_count": {
            "type": "integer"
          },
          "role": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "OrgMember": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "role": {
            "type": "string",
            "enum": [
              "owner",
              "admin",
              "member",
              "viewer",
              "auditor"
            ]
          },
          "accepted_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "OrgInvitation": {
        "type": "object",
        "properties": {
          "invitation_id": {
            "type": "string"
          },
          "org_id": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "role": {
            "type": "string"
          },
          "token": {
            "type": "string",
            "description": "Only returned on creation"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "accepted",
              "revoked",
              "expired"
            ]
          },
          "invited_by": {
            "type": "string"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "License": {
        "type": "object",
        "properties": {
          "license_id": {
            "type": "string"
          },
          "account_id": {
            "type": "string"
          },
          "plan_id": {
            "type": "string"
          },
          "feature_flags": {
            "type": "object",
            "additionalProperties": {
              "type": "boolean"
            }
          },
          "limits": {
            "type": "object"
          },
          "max_activations": {
            "type": "integer"
          },
          "is_offline": {
            "type": "boolean"
          },
          "issued_at": {
            "type": "string",
            "format": "date-time"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time"
          },
          "revoked_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "revoked_reason": {
            "type": [
              "string",
              "null"
            ]
          },
          "notes": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ApiKey": {
        "type": "object",
        "properties": {
          "key_id": {
            "type": "string"
          },
          "key": {
            "type": "string",
            "description": "Full secret key, only returned on creation"
          },
          "key_prefix": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "org_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "scopes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "last_used_at": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          }
        }
      },
      "WebhookEndpoint": {
        "type": "object",
        "description": "Webhook endpoint with signing secret (only returned on creation and secret rotation)",
        "properties": {
          "endpoint_id": {
            "type": "string",
            "description": "Unique identifier (whe-xxxxxxxx)"
          },
          "billing_account_id": {
            "type": "string"
          },
          "url": {
            "type": "string",
            "format": "uri"
          },
          "description": {
            "type": "string"
          },
          "signing_secret": {
            "type": "string",
            "description": "32-byte hex-encoded HMAC signing secret. Only returned on creation and rotation."
          },
          "event_types": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Subscribed event types. Empty array means all events."
          },
          "is_active": {
            "type": "boolean"
          },
          "consecutive_failures": {
            "type": "integer"
          },
          "disabled_at": {
            "type": ["string", "null"],
            "format": "date-time"
          },
          "disabled_reason": {
            "type": ["string", "null"]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "WebhookEndpointPublic": {
        "type": "object",
        "description": "Webhook endpoint without signing secret (used in list and get responses)",
        "properties": {
          "endpoint_id": {
            "type": "string"
          },
          "billing_account_id": {
            "type": "string"
          },
          "url": {
            "type": "string",
            "format": "uri"
          },
          "description": {
            "type": "string"
          },
          "event_types": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "is_active": {
            "type": "boolean"
          },
          "consecutive_failures": {
            "type": "integer"
          },
          "disabled_at": {
            "type": ["string", "null"],
            "format": "date-time"
          },
          "disabled_reason": {
            "type": ["string", "null"]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "WebhookDelivery": {
        "type": "object",
        "description": "Webhook delivery log entry",
        "properties": {
          "delivery_id": {
            "type": "string",
            "description": "Unique identifier (whd-xxxxxxxx)"
          },
          "event_id": {
            "type": "string"
          },
          "endpoint_id": {
            "type": "string"
          },
          "event_type": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "delivering", "delivered", "failed", "retrying"]
          },
          "attempt_count": {
            "type": "integer"
          },
          "max_attempts": {
            "type": "integer"
          },
          "last_response_status": {
            "type": ["integer", "null"],
            "description": "HTTP status code from last delivery attempt"
          },
          "last_error": {
            "type": ["string", "null"]
          },
          "latency_ms": {
            "type": ["integer", "null"],
            "description": "Round-trip latency in milliseconds"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "SigningKeyInfo": {
        "type": "object",
        "description": "Ed25519 signing key metadata. Public keys are used to verify IntegrityCertificate signatures.",
        "properties": {
          "key_id": {
            "type": "string",
            "description": "Unique key identifier"
          },
          "public_key": {
            "type": "string",
            "description": "Hex-encoded Ed25519 public key"
          },
          "algorithm": {
            "type": "string",
            "description": "Signing algorithm (always Ed25519)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the key was created"
          },
          "is_active": {
            "type": "boolean",
            "description": "Whether the key is currently in use for new signatures"
          }
        },
        "required": ["key_id", "public_key", "algorithm", "created_at", "is_active"]
      },
      "IntegrityCertificate": {
        "type": "object",
        "description": "Machine-readable cryptographic certificate for an integrity checkpoint. Modeled on C2PA content credentials and W3C Verifiable Credentials.",
        "properties": {
          "@context": {
            "type": "string",
            "description": "Namespace identifier",
            "enum": ["https://mnemom.ai/aip/v1"]
          },
          "type": {
            "type": "string",
            "enum": ["IntegrityCertificate"]
          },
          "version": {
            "type": "string",
            "description": "Certificate format version"
          },
          "certificate_id": {
            "type": "string",
            "description": "Unique certificate identifier (cert-{8 random chars})"
          },
          "issued_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of certificate issuance"
          },
          "subject": {
            "type": "object",
            "description": "Identifies the checkpoint this certificate attests to",
            "properties": {
              "checkpoint_id": {
                "type": "string",
                "description": "Integrity checkpoint ID (ic-{uuid})"
              },
              "agent_id": {
                "type": "string"
              },
              "session_id": {
                "type": "string"
              },
              "card_id": {
                "type": "string"
              }
            },
            "required": ["checkpoint_id", "agent_id", "session_id", "card_id"]
          },
          "claims": {
            "type": "object",
            "description": "Analysis verdict and supporting evidence",
            "properties": {
              "verdict": {
                "type": "string",
                "enum": ["clear", "review_needed", "boundary_violation"]
              },
              "concerns": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "category": {
                      "type": "string"
                    },
                    "severity": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    }
                  }
                }
              },
              "confidence": {
                "type": "number",
                "description": "Extraction confidence (0.0-1.0)"
              },
              "reasoning_summary": {
                "type": "string"
              },
              "analysis_model": {
                "type": "string"
              },
              "analysis_duration_ms": {
                "type": "number"
              }
            }
          },
          "input_commitments": {
            "type": "object",
            "description": "Cryptographic commitments to analysis inputs",
            "properties": {
              "thinking_block_hash": {
                "type": "string",
                "description": "SHA-256 hash of the thinking block"
              },
              "card_hash": {
                "type": "string",
                "description": "SHA-256 hash of the Alignment Card"
              },
              "values_hash": {
                "type": "string",
                "description": "SHA-256 hash of conscience values"
              },
              "context_hash": {
                "type": "string",
                "description": "SHA-256 hash of window context"
              },
              "model_version": {
                "type": "string"
              },
              "combined_commitment": {
                "type": "string",
                "description": "SHA-256 of all input fields concatenated"
              }
            }
          },
          "proofs": {
            "type": "object",
            "description": "Cryptographic evidence supporting the claims",
            "properties": {
              "signature": {
                "type": "object",
                "properties": {
                  "algorithm": {
                    "type": "string",
                    "enum": ["Ed25519"]
                  },
                  "key_id": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string",
                    "description": "Base64-encoded Ed25519 signature"
                  },
                  "signed_payload": {
                    "type": "string",
                    "description": "Deterministic JSON string that was signed"
                  }
                }
              },
              "chain": {
                "type": "object",
                "properties": {
                  "chain_hash": {
                    "type": "string"
                  },
                  "prev_chain_hash": {
                    "type": ["string", "null"]
                  },
                  "position": {
                    "type": "integer"
                  }
                }
              },
              "merkle": {
                "type": ["object", "null"],
                "description": "Merkle inclusion proof. Null if not yet added to tree.",
                "properties": {
                  "leaf_hash": {
                    "type": "string"
                  },
                  "leaf_index": {
                    "type": "integer"
                  },
                  "root": {
                    "type": "string"
                  },
                  "tree_size": {
                    "type": "integer"
                  },
                  "inclusion_proof": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "hash": {
                          "type": "string"
                        },
                        "position": {
                          "type": "string",
                          "enum": ["left", "right"]
                        }
                      }
                    }
                  }
                }
              },
              "verdict_derivation": {
                "type": ["object", "null"],
                "description": "SP1 STARK proof. Null if not yet proven.",
                "properties": {
                  "method": {
                    "type": "string",
                    "enum": ["SP1-STARK"]
                  },
                  "image_id": {
                    "type": "string"
                  },
                  "receipt": {
                    "type": "string",
                    "description": "Base64-encoded STARK proof receipt"
                  },
                  "journal": {
                    "type": "string",
                    "description": "Base64-encoded public journal"
                  },
                  "verified_at": {
                    "type": "string",
                    "format": "date-time"
                  }
                }
              }
            }
          },
          "verification": {
            "type": "object",
            "description": "URLs for independent verification",
            "properties": {
              "keys_url": {
                "type": "string",
                "format": "uri"
              },
              "certificate_url": {
                "type": "string",
                "format": "uri"
              },
              "verify_url": {
                "type": "string",
                "format": "uri"
              }
            }
          }
        },
        "required": ["@context", "type", "version", "certificate_id", "issued_at", "subject", "claims", "input_commitments", "proofs", "verification"]
      },
      "MerkleRootResponse": {
        "type": "object",
        "description": "Current Merkle tree root and metadata for an agent",
        "properties": {
          "agent_id": {
            "type": "string",
            "description": "The agent ID"
          },
          "merkle_root": {
            "type": "string",
            "description": "SHA-256 Merkle root hash (hex-encoded)"
          },
          "tree_depth": {
            "type": "integer",
            "description": "Depth of the Merkle tree (ceil(log2(leaf_count)))"
          },
          "leaf_count": {
            "type": "integer",
            "description": "Total number of checkpoint leaves in the tree"
          },
          "last_updated": {
            "type": "string",
            "format": "date-time",
            "description": "When the tree was last updated"
          }
        },
        "required": ["agent_id", "merkle_root", "tree_depth", "leaf_count", "last_updated"]
      },
      "InclusionProofResponse": {
        "type": "object",
        "description": "Merkle inclusion proof for a checkpoint",
        "properties": {
          "checkpoint_id": {
            "type": "string",
            "description": "The checkpoint ID"
          },
          "leaf_hash": {
            "type": "string",
            "description": "SHA-256 leaf hash of this checkpoint"
          },
          "leaf_index": {
            "type": "integer",
            "description": "Index of this leaf in the tree"
          },
          "siblings": {
            "type": "array",
            "description": "O(log N) sibling hashes for proof verification",
            "items": {
              "type": "object",
              "properties": {
                "hash": {
                  "type": "string",
                  "description": "Hex-encoded sibling hash"
                },
                "position": {
                  "type": "string",
                  "enum": ["left", "right"],
                  "description": "Position of sibling relative to the path node"
                }
              },
              "required": ["hash", "position"]
            }
          },
          "root": {
            "type": "string",
            "description": "Current Merkle root (hex-encoded)"
          },
          "tree_size": {
            "type": "integer",
            "description": "Total number of leaves in the tree"
          },
          "verified": {
            "type": "boolean",
            "description": "Whether the proof was verified against the stored root"
          }
        },
        "required": ["checkpoint_id", "leaf_hash", "leaf_index", "siblings", "root", "tree_size", "verified"]
      },
      "ProofStatusResponse": {
        "type": "object",
        "description": "ZK proof status and metadata for a checkpoint",
        "properties": {
          "proof_id": {
            "type": "string",
            "description": "Proof identifier (prf-{8 random chars})"
          },
          "checkpoint_id": {
            "type": "string",
            "description": "The checkpoint this proof is for"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "proving", "completed", "failed"],
            "description": "Current proof status"
          },
          "proof_type": {
            "type": "string",
            "description": "Proof system (e.g., sp1-stark)"
          },
          "image_id": {
            "type": ["string", "null"],
            "description": "Guest program image ID (set when proving begins)"
          },
          "proving_duration_ms": {
            "type": ["integer", "null"],
            "description": "Wall-clock proving time in milliseconds (set when completed)"
          },
          "verified": {
            "type": "boolean",
            "description": "Whether the proof has been verified"
          },
          "verified_at": {
            "type": ["string", "null"],
            "format": "date-time",
            "description": "When the proof was verified (null if not yet verified)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the proof request was created"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the proof record was last updated"
          }
        },
        "required": ["proof_id", "checkpoint_id", "status", "proof_type", "verified", "created_at", "updated_at"]
      },
      "VerifyCertificateResponse": {
        "type": "object",
        "description": "Result of certificate verification",
        "properties": {
          "valid": {
            "type": "boolean",
            "description": "Whether all verification checks passed"
          },
          "checks": {
            "type": "object",
            "description": "Individual verification check results",
            "properties": {
              "signature": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "key_id": {
                    "type": "string"
                  }
                },
                "required": ["valid", "key_id"]
              },
              "chain": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "chain_hash": {
                    "type": "string"
                  }
                },
                "required": ["valid", "chain_hash"]
              },
              "merkle": {
                "type": ["object", "null"],
                "description": "Null if Merkle proof was not present in the certificate",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "root": {
                    "type": "string"
                  }
                }
              },
              "input_commitment": {
                "type": "object",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "commitment": {
                    "type": "string"
                  }
                },
                "required": ["valid", "commitment"]
              },
              "verdict_derivation": {
                "type": ["object", "null"],
                "description": "Null if verdict derivation proof was not present",
                "properties": {
                  "valid": {
                    "type": "boolean"
                  },
                  "method": {
                    "type": "string"
                  }
                }
              }
            },
            "required": ["signature", "chain", "input_commitment"]
          },
          "details": {
            "type": "string",
            "description": "Semicolon-separated human-readable verification details"
          }
        },
        "required": ["valid", "checks", "details"]
      },
      "ErrorResponse": {
        "type": "object",
        "description": "Standard error response",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message"
          }
        },
        "required": ["error"]
      },
      "OrgConscienceValue": {
        "type": "object",
        "description": "A custom conscience value for an organization",
        "properties": {
          "id": {"type": "string", "description": "Value ID (cv-xxx)"},
          "org_id": {"type": "string"},
          "name": {"type": "string", "maxLength": 50},
          "description": {"type": "string", "maxLength": 500},
          "type": {"type": "string", "enum": ["BOUNDARY", "FEAR", "COMMITMENT", "BELIEF", "HOPE"]},
          "severity": {"type": "string", "enum": ["advisory", "mandatory"]},
          "scope": {"type": "string"},
          "is_active": {"type": "boolean"},
          "sort_order": {"type": "integer"},
          "created_by": {"type": "string"},
          "updated_by": {"type": "string"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        },
        "required": ["id", "org_id", "name", "description", "type", "severity"]
      },
      "OrgConscienceAuditEntry": {
        "type": "object",
        "description": "Audit log entry for conscience value changes",
        "properties": {
          "id": {"type": "string"},
          "org_id": {"type": "string"},
          "value_id": {"type": ["string", "null"]},
          "action": {"type": "string", "enum": ["create", "update", "delete", "activate", "deactivate", "reorder", "mode_change"]},
          "actor": {"type": "string"},
          "changes": {"type": "object"},
          "metadata": {"type": "object"},
          "created_at": {"type": "string", "format": "date-time"}
        },
        "required": ["id", "org_id", "action", "actor", "created_at"]
      },
      "OrgCardTemplate": {
        "type": "object",
        "description": "Organization alignment card template that all agents inherit",
        "properties": {
          "org_id": {"type": "string", "description": "Organization ID"},
          "enabled": {"type": "boolean", "description": "Whether the template is active"},
          "template": {"$ref": "#/components/schemas/AlignmentCard", "description": "The alignment card template JSON"},
          "created_by": {"type": "string", "description": "User ID who created the template"},
          "updated_by": {"type": "string", "description": "User ID who last updated the template"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        },
        "required": ["org_id", "enabled", "template"]
      },
      "Team": {
        "type": "object",
        "properties": {
          "id": {"type": "string", "description": "Team identifier (UUID)"},
          "org_id": {"type": "string", "description": "Organization that owns this team"},
          "name": {"type": "string", "description": "Display name"},
          "description": {"type": ["string", "null"], "description": "Optional description"},
          "status": {"type": "string", "enum": ["active", "archived"], "description": "Team status"},
          "metadata": {"type": "object", "additionalProperties": true, "description": "Freeform metadata"},
          "member_count": {"type": "integer", "description": "Number of active members"},
          "created_at": {"type": "string", "format": "date-time"},
          "updated_at": {"type": "string", "format": "date-time"}
        }
      },
      "TeamMember": {
        "type": "object",
        "properties": {
          "team_id": {"type": "string"},
          "agent_id": {"type": "string"},
          "agent_name": {"type": "string"},
          "added_at": {"type": "string", "format": "date-time"},
          "removed_at": {"type": ["string", "null"], "format": "date-time"}
        }
      },
      "TeamRosterChange": {
        "type": "object",
        "properties": {
          "id": {"type": "string"},
          "team_id": {"type": "string"},
          "change_type": {"type": "string", "enum": ["agent_added", "agent_removed"]},
          "agent_id": {"type": "string"},
          "actor_id": {"type": ["string", "null"]},
          "created_at": {"type": "string", "format": "date-time"}
        }
      },
      "TeamReputationScore": {
        "type": "object",
        "properties": {
          "team_id": {"type": "string"},
          "team_name": {"type": "string"},
          "score": {"type": "number", "description": "0-1000"},
          "grade": {"type": "string", "enum": ["AAA", "AA", "A", "BBB", "BB", "B", "CCC", "NR"]},
          "confidence": {"type": "string", "enum": ["insufficient", "low", "medium", "high"]},
          "is_eligible": {"type": "boolean", "description": "true when total_assessments >= 10"},
          "components": {
            "type": "array",
            "items": {"$ref": "#/components/schemas/TeamReputationComponent"}
          },
          "total_assessments": {"type": "integer"},
          "last_assessed": {"type": ["string", "null"], "format": "date-time"},
          "trend_30d": {"type": "number"},
          "visibility": {"type": "string", "enum": ["public", "unlisted", "private"]},
          "computed_at": {"type": "string", "format": "date-time"},
          "member_count": {"type": "integer"},
          "a2a_trust_extension": {"$ref": "#/components/schemas/A2ATeamTrustExtension"}
        }
      },
      "TeamReputationComponent": {
        "type": "object",
        "properties": {
          "key": {"type": "string", "enum": ["coherence_history", "member_quality", "operational_record", "structural_stability", "assessment_density"]},
          "label": {"type": "string"},
          "score": {"type": "number", "description": "Raw score 0-1000"},
          "weight": {"type": "number", "description": "Weight 0-1"},
          "weighted_score": {"type": "number", "description": "score * weight"},
          "factors": {"type": "array", "items": {"type": "string"}}
        }
      },
      "A2ATeamTrustExtension": {
        "type": "object",
        "properties": {
          "extension_uri": {"type": "string"},
          "provider": {"type": "string"},
          "score": {"type": "number"},
          "grade": {"type": "string"},
          "confidence": {"type": "string"},
          "member_count": {"type": "integer"},
          "verified_url": {"type": "string", "format": "uri"},
          "badge_url": {"type": "string", "format": "uri"},
          "methodology_url": {"type": "string", "format": "uri"},
          "last_updated": {"type": "string", "format": "date-time"}
        }
      },
      "TeamReputationSnapshot": {
        "type": "object",
        "properties": {
          "team_id": {"type": "string"},
          "week_start": {"type": "string", "format": "date"},
          "score": {"type": "number"},
          "grade": {"type": "string"},
          "components": {"type": "object", "additionalProperties": {"type": "number"}},
          "created_at": {"type": "string", "format": "date-time"}
        }
      },
      "PolicyMeta": {
        "type": "object",
        "description": "Metadata for a CLPI policy including schema version, name, description, and scope.",
        "properties": {
          "schema_version": {
            "type": "string",
            "description": "Semantic version of the policy schema (e.g. '1.0.0')"
          },
          "name": {
            "type": "string",
            "description": "Human-readable name of the policy"
          },
          "description": {
            "type": "string",
            "description": "Detailed description of the policy's purpose"
          },
          "scope": {
            "type": "string",
            "enum": ["agent", "org", "global"],
            "description": "Scope at which the policy applies"
          }
        }
      },
      "CapabilityMapping": {
        "type": "object",
        "description": "Maps a named capability to specific tools and alignment card actions.",
        "properties": {
          "description": {
            "type": "string",
            "description": "Human-readable description of what this capability represents"
          },
          "tools": {
            "type": "array",
            "items": {"type": "string"},
            "description": "List of tool identifiers that belong to this capability"
          },
          "card_actions": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Alignment card action types associated with this capability"
          }
        }
      },
      "ForbiddenRule": {
        "type": "object",
        "description": "A rule that forbids tools matching a specific pattern.",
        "required": ["pattern", "reason"],
        "properties": {
          "pattern": {
            "type": "string",
            "description": "Glob or regex pattern matching tool identifiers to forbid"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable reason why these tools are forbidden"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "default": "high",
            "description": "Severity level when a forbidden tool is invoked"
          }
        }
      },
      "EscalationTrigger": {
        "type": "object",
        "description": "Defines a condition that triggers an escalation action.",
        "required": ["condition", "action"],
        "properties": {
          "condition": {
            "type": "string",
            "description": "Expression or rule describing when this trigger fires (e.g. 'violation_count > 3')"
          },
          "action": {
            "type": "string",
            "enum": ["notify", "pause", "block", "require_approval"],
            "description": "Action to take when the condition is met"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable explanation of why this escalation exists"
          }
        }
      },
      "PolicyDefaults": {
        "type": "object",
        "description": "Default enforcement behavior for tools and situations not explicitly covered by the policy.",
        "properties": {
          "unmapped_tool_action": {
            "type": "string",
            "enum": ["allow", "warn", "block", "escalate"],
            "default": "warn",
            "description": "Action to take when a tool is not mapped to any capability"
          },
          "unmapped_severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "default": "medium",
            "description": "Severity level assigned to unmapped tool invocations"
          },
          "fail_open": {
            "type": "boolean",
            "default": false,
            "description": "If true, allow actions when the policy engine is unavailable. If false, block by default."
          },
          "enforcement_mode": {
            "type": "string",
            "enum": ["observe", "enforce", "nudge"],
            "default": "observe",
            "description": "Default enforcement mode for the policy"
          },
          "grace_period_hours": {
            "type": "integer",
            "default": 0,
            "description": "Number of hours to allow violations before enforcement kicks in (for new policy rollouts)"
          }
        }
      },
      "Policy": {
        "type": "object",
        "description": "A complete CLPI policy document defining capability mappings, forbidden tools, escalation triggers, and enforcement defaults.",
        "properties": {
          "meta": {
            "$ref": "#/components/schemas/PolicyMeta"
          },
          "capability_mappings": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/CapabilityMapping"
            },
            "description": "Map of capability names to their definitions"
          },
          "forbidden": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ForbiddenRule"
            },
            "description": "List of forbidden tool rules"
          },
          "escalation_triggers": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EscalationTrigger"
            },
            "description": "List of escalation trigger definitions"
          },
          "defaults": {
            "$ref": "#/components/schemas/PolicyDefaults"
          }
        }
      },
      "PolicyViolation": {
        "type": "object",
        "description": "A single policy violation detected during evaluation.",
        "properties": {
          "type": {
            "type": "string",
            "enum": ["forbidden", "unmapped", "escalation", "capability_mismatch"],
            "description": "Type of policy violation"
          },
          "tool": {
            "type": "string",
            "description": "Tool identifier that triggered the violation"
          },
          "capability": {
            "type": ["string", "null"],
            "description": "Capability the tool was mapped to, if any"
          },
          "rule": {
            "type": ["string", "null"],
            "description": "The specific rule or pattern that was matched"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable explanation of the violation"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Severity level of the violation"
          }
        }
      },
      "PolicyEvaluationResult": {
        "type": "object",
        "description": "Result of evaluating a CLPI policy against a set of tools or traces.",
        "properties": {
          "verdict": {
            "type": "string",
            "enum": ["pass", "warn", "fail"],
            "description": "Overall evaluation verdict"
          },
          "violations": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PolicyViolation"
            },
            "description": "List of policy violations detected"
          },
          "warnings": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "tool": {"type": "string"},
                "message": {"type": "string"}
              }
            },
            "description": "Non-blocking warnings about potential issues"
          },
          "card_gaps": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "capability": {"type": "string"},
                "missing_card_field": {"type": "string"},
                "suggestion": {"type": "string"}
              }
            },
            "description": "Gaps between the policy and the alignment card"
          },
          "coverage": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Fraction of tools covered by the policy (0.0 to 1.0)"
          }
        }
      },
      "ReclassificationRequest": {
        "type": "object",
        "description": "Request to reclassify a checkpoint violation.",
        "required": ["checkpoint_id", "reason"],
        "properties": {
          "checkpoint_id": {
            "type": "string",
            "description": "Identifier of the checkpoint to reclassify"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable justification for the reclassification"
          },
          "card_amendment_id": {
            "type": ["string", "null"],
            "description": "Optional ID of an alignment card amendment that triggered this reclassification"
          }
        }
      },
      "ReclassificationResult": {
        "type": "object",
        "description": "Result of a checkpoint violation reclassification.",
        "properties": {
          "reclassification_id": {
            "type": "string",
            "description": "Unique identifier for this reclassification"
          },
          "checkpoint_id": {
            "type": "string",
            "description": "Identifier of the reclassified checkpoint"
          },
          "agent_id": {
            "type": "string",
            "description": "Agent whose checkpoint was reclassified"
          },
          "original_type": {
            "type": "string",
            "description": "Original violation type before reclassification"
          },
          "new_type": {
            "type": "string",
            "description": "New violation type after reclassification"
          },
          "reason": {
            "type": "string",
            "description": "Justification provided for the reclassification"
          },
          "score_impact": {
            "type": "object",
            "properties": {
              "previous_score": {"type": "number"},
              "new_score": {"type": "number"},
              "delta": {"type": "number"}
            },
            "description": "Impact of the reclassification on the agent's score"
          }
        }
      },
      "FaultLine": {
        "type": "object",
        "description": "A single fault line identified in team alignment analysis.",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique identifier for this fault line"
          },
          "value": {
            "type": "string",
            "description": "The specific value, capability, or constraint that constitutes the fault line"
          },
          "classification": {
            "type": "string",
            "enum": ["capability_gap", "value_mismatch", "constraint_inconsistency", "tool_divergence", "policy_conflict"],
            "description": "Classification of the fault line type"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Severity of the fault line"
          },
          "agents_declaring": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Agent IDs that declare or satisfy this requirement"
          },
          "agents_missing": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Agent IDs that are missing this requirement"
          },
          "impact_score": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Estimated impact of this fault line on team alignment (0.0 to 1.0)"
          },
          "resolution_hint": {
            "type": "string",
            "description": "Suggested action to resolve this fault line"
          }
        }
      },
      "FaultLineAnalysis": {
        "type": "object",
        "description": "Complete fault line analysis result for a team.",
        "properties": {
          "team_id": {
            "type": "string",
            "description": "Team that was analyzed"
          },
          "analysis_id": {
            "type": "string",
            "description": "Unique identifier for this analysis run"
          },
          "fleet_score": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Overall fleet alignment score (0-100)"
          },
          "fault_lines": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/FaultLine"
            },
            "description": "Identified fault lines sorted by severity"
          },
          "summary": {
            "type": "string",
            "description": "Human-readable summary of the analysis findings"
          }
        }
      },
      "RiskForecast": {
        "type": "object",
        "description": "Risk forecast for a team based on alignment trends and fault lines.",
        "properties": {
          "forecast_id": {
            "type": "string",
            "description": "Unique identifier for this forecast"
          },
          "failure_modes": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "mode": {"type": "string", "description": "Description of the potential failure mode"},
                "probability": {"type": "number", "minimum": 0, "maximum": 1, "description": "Estimated probability of occurrence"},
                "impact": {"type": "string", "enum": ["low", "medium", "high", "critical"], "description": "Estimated impact if the failure occurs"},
                "contributing_factors": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Factors contributing to this risk"
                },
                "mitigation": {"type": "string", "description": "Suggested mitigation action"}
              }
            },
            "description": "Ranked list of potential failure modes"
          },
          "overall_risk_level": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Overall risk level for the team"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Confidence level of the forecast (0.0 to 1.0)"
          }
        }
      },
      "OnChainAnchorResult": {
        "type": "object",
        "description": "Result of an on-chain Merkle root anchoring operation.",
        "properties": {
          "anchor_id": {
            "type": "string",
            "description": "Unique identifier for this anchor"
          },
          "merkle_root": {
            "type": "string",
            "description": "Hex-encoded Merkle root hash that was anchored"
          },
          "tx_hash": {
            "type": "string",
            "description": "Blockchain transaction hash"
          },
          "block_number": {
            "type": "integer",
            "description": "Block number in which the transaction was included"
          },
          "gas_used": {
            "type": "integer",
            "description": "Gas consumed by the anchoring transaction"
          },
          "chain": {
            "type": "string",
            "enum": ["ethereum", "polygon", "base"],
            "description": "Blockchain network where the anchor was created"
          },
          "agent_ids": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Agent IDs included in this anchor"
          },
          "anchored_at": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the anchor was created"
          }
        }
      }
    }
  }
}